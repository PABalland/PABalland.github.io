<!doctype html>
<html>

<head>

    <meta charset="utf-8">
    <title>Forced Network</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>

    <style>
        html,
        body {
            margin: 0;
            height: 100%;
            font-family: "Avenir Next", "Helvetica Neue", Arial, sans-serif;
            background: #f5f7fa;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        #legend-container {
            flex: 0 0 auto;
            max-height: 12%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: clamp(4px, 1.2vh, 12px) clamp(8px, 3vw, 32px);
            background: rgba(255, 255, 255, 0.96);
            order: 2;
            overflow-y: auto;
            scrollbar-width: thin;
        }

        .custom-legend {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: clamp(6px, 1.5vw, 16px);
            width: 100%;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: clamp(4px, 0.5vw, 8px);
            font-weight: 600;
            color: #1b1d21;
            font-size: clamp(10px, 1.3vw, 16px);
            cursor: default;
            white-space: nowrap;
        }

        .legend-item.dim {
            opacity: 0.35;
        }

        .legend-square {
            width: clamp(10px, 1.2vw, 16px);
            height: clamp(10px, 1.2vw, 16px);
            flex-shrink: 0;
        }

        .legend-label {
            pointer-events: none;
        }

        @media (max-width: 600px) {
            #legend-container {
                padding: 4px 8px;
                max-height: 18%;
            }

            .custom-legend {
                gap: 4px 8px;
            }

            .legend-item {
                font-size: 10px;
                gap: 3px;
            }

            .legend-square {
                width: 8px;
                height: 8px;
            }
        }

        svg.network {
            flex: 1 1 auto;
            width: 100%;
            height: 100%;
            display: block;
            cursor: move;
            background: #ffffff;
            order: 1;
        }

        .link {
            stroke: rgba(140, 150, 170, 0.45);
        }

        .link.highlighted {
            stroke: rgba(80, 90, 110, 0.9);
            stroke-width: 6px;
        }

        .link.dimmed {
            opacity: 0.2;
        }

        .node.dimmed {
            opacity: 0.25;
        }

        .node.highlighted circle {
            stroke-width: 3px;
        }

        .node.highlighted text {
            font-weight: 700;
        }

        .node circle {
            stroke: #ffffff;
            stroke-width: 2px;
        }

        .node text {
            font-weight: 400;
            text-anchor: middle;
            dominant-baseline: central;
            pointer-events: none;
            font-family: "Helvetica Neue", Arial, sans-serif;
        }
    </style>

</head>

<body>

    <div id="legend-container">
        <div class="custom-legend" id="legend"></div>
    </div>

    <svg class="network"></svg>

    <script>

        var nodes = [{ "id": "Advanced Biologics & Cell Therapies", "id2": 0, "x": -0.7505, "y": -1.5456, "color": "#e28f26", "parent": "Therapeutics & Pharma", "size": 1.5 }, { "id": "Air and Water Quality Sensors", "id2": 1, "x": 0.9768, "y": 2.6689, "color": "#800020", "parent": "Health Systems & Environment", "size": 1.5 }, { "id": "AMR Solutions", "id2": 2, "x": 1.0099, "y": 1.062, "color": "#e28f26", "parent": "Therapeutics & Pharma", "size": 1.5 }, { "id": "Autonomous Tractors and Drones", "id2": 3, "x": 2.4291, "y": 0.051, "color": "#c2785c", "parent": "AgriTech & Supply Chain", "size": 1.5 }, { "id": "Biosensors and Wearables", "id2": 4, "x": -0.4587, "y": 1.4768, "color": "#669999", "parent": "Diagnostics & Devices", "size": 1.5 }, { "id": "Breeding", "id2": 5, "x": -0.0957, "y": -2.254, "color": "#8cab79", "parent": "Agricultural Biotechnology", "size": 1.5 }, { "id": "Climate-smart technologies", "id2": 6, "x": 2.8031, "y": 1.6926, "color": "#c2785c", "parent": "AgriTech & Supply Chain", "size": 1.5 }, { "id": "Digital Therapeutics", "id2": 25, "x": -0.3761, "y": 2.6306, "color": "#365a94", "parent": "Data & Digital Technologies", "size": 1.5 }, { "id": "DNA Technology - Genetically modified organisms (GMOs)", "id2": 7, "x": -0.7358, "y": -1.066, "color": "#8cab79", "parent": "Agricultural Biotechnology", "size": 1.5 }, { "id": "Electronic Health Records", "id2": 8, "x": -1.013, "y": 2.7345, "color": "#365a94", "parent": "Data & Digital Technologies", "size": 1.5 }, { "id": "Fertilisers and Pesticides", "id2": 9, "x": 0.8865, "y": -1.8974, "color": "#8cab79", "parent": "Agricultural Biotechnology", "size": 1.5 }, { "id": "Geographic Information Systems (GIS) and Remote Sensing", "id2": 10, "x": 2.1713, "y": 0.4661, "color": "#365a94", "parent": "Data & Digital Technologies", "size": 1.5 }, { "id": "Imaging Technology", "id2": 16, "x": -0.1294, "y": 1.9263, "color": "#669999", "parent": "Diagnostics & Devices", "size": 1.5 }, { "id": "Infectious Diseases Tests", "id2": 24, "x": -0.7394, "y": 0.1721, "color": "#669999", "parent": "Diagnostics & Devices", "size": 1.5 }, { "id": "Livestock technologies", "id2": 15, "x": -1.2193, "y": -2.7702, "color": "#8cab79", "parent": "Agricultural Biotechnology", "size": 1.5 }, { "id": "Plant Tissue Culture", "id2": 21, "x": 0.2019, "y": -1.5109, "color": "#8cab79", "parent": "Agricultural Biotechnology", "size": 1.5 }, { "id": "Precision agriculture", "id2": 19, "x": 1.6324, "y": -0.2271, "color": "#8cab79", "parent": "Agricultural Biotechnology", "size": 1.5 }, { "id": "Prosthetics", "id2": 11, "x": -1.6531, "y": 2.2425, "color": "#669999", "parent": "Diagnostics & Devices", "size": 1.5 }, { "id": "Rehab Robotics", "id2": 12, "x": -1.1852, "y": 2.2561, "color": "#669999", "parent": "Diagnostics & Devices", "size": 1.5 }, { "id": "Supply Chain Management", "id2": 20, "x": 2.2983, "y": 1.5692, "color": "#800020", "parent": "Health Systems & Environment", "size": 1.5 }, { "id": "Surgical Devices", "id2": 17, "x": -0.7055, "y": 1.8831, "color": "#669999", "parent": "Diagnostics & Devices", "size": 1.5 }, { "id": "Telemedicine", "id2": 22, "x": -0.5315, "y": 3.1185, "color": "#365a94", "parent": "Data & Digital Technologies", "size": 1.5 }, { "id": "Vaccines", "id2": 23, "x": -1.1248, "y": -2.0661, "color": "#e28f26", "parent": "Therapeutics & Pharma", "size": 1.5 }, { "id": "Vector Control", "id2": 18, "x": -0.4869, "y": -2.4042, "color": "#800020", "parent": "Health Systems & Environment", "size": 1.5 }, { "id": "Water And Sanitation Hygiene Technologies", "id2": 13, "x": 2.7256, "y": 2.9179, "color": "#800020", "parent": "Health Systems & Environment", "size": 1.5 }, { "id": "Water management", "id2": 14, "x": 2.2977, "y": 3.0959, "color": "#c2785c", "parent": "AgriTech & Supply Chain", "size": 1.5 }];

        var links = [{ "source": "Advanced Biologics & Cell Therapies", "target": "DNA Technology - Genetically modified organisms (GMOs)", "weight": 24.27 }, { "source": "Advanced Biologics & Cell Therapies", "target": "Plant Tissue Culture", "weight": 18.48 }, { "source": "Advanced Biologics & Cell Therapies", "target": "Vaccines", "weight": 15.12 }, { "source": "Air and Water Quality Sensors", "target": "Biosensors and Wearables", "weight": 9.89 }, { "source": "Air and Water Quality Sensors", "target": "Water And Sanitation Hygiene Technologies", "weight": 6.85 }, { "source": "AMR Solutions", "target": "Autonomous Tractors and Drones", "weight": 19.13 }, { "source": "AMR Solutions", "target": "Supply Chain Management", "weight": 18.52 }, { "source": "Autonomous Tractors and Drones", "target": "Precision agriculture", "weight": 11.73 }, { "source": "Biosensors and Wearables", "target": "Digital Therapeutics", "weight": 13.1 }, { "source": "Biosensors and Wearables", "target": "Electronic Health Records", "weight": 17.37 }, { "source": "Biosensors and Wearables", "target": "Imaging Technology", "weight": 30.9 }, { "source": "Biosensors and Wearables", "target": "Infectious Diseases Tests", "weight": 8.48 }, { "source": "Biosensors and Wearables", "target": "Surgical Devices", "weight": 23.21 }, { "source": "Breeding", "target": "Livestock technologies", "weight": 32.13 }, { "source": "Climate-smart technologies", "target": "Water management", "weight": 7.35 }, { "source": "Breeding", "target": "DNA Technology - Genetically modified organisms (GMOs)", "weight": 11.62 }, { "source": "DNA Technology - Genetically modified organisms (GMOs)", "target": "Infectious Diseases Tests", "weight": 13.6 }, { "source": "Electronic Health Records", "target": "Telemedicine", "weight": 16.29 }, { "source": "Fertilisers and Pesticides", "target": "Plant Tissue Culture", "weight": 13.01 }, { "source": "Fertilisers and Pesticides", "target": "Precision agriculture", "weight": 15.87 }, { "source": "Fertilisers and Pesticides", "target": "Vector Control", "weight": 21.89 }, { "source": "Geographic Information Systems (GIS) and Remote Sensing", "target": "Precision agriculture", "weight": 19.3 }, { "source": "Prosthetics", "target": "Rehab Robotics", "weight": 21.77 }, { "source": "Rehab Robotics", "target": "Surgical Devices", "weight": 25.14 }, { "source": "Water And Sanitation Hygiene Technologies", "target": "Water management", "weight": 41.77 }, { "source": "Water management", "target": "Water And Sanitation Hygiene Technologies", "weight": 41.77 }, { "source": "Livestock technologies", "target": "Breeding", "weight": 32.13 }, { "source": "Imaging Technology", "target": "Biosensors and Wearables", "weight": 30.9 }, { "source": "Surgical Devices", "target": "Rehab Robotics", "weight": 25.14 }, { "source": "DNA Technology - Genetically modified organisms (GMOs)", "target": "Advanced Biologics & Cell Therapies", "weight": 24.27 }, { "source": "Surgical Devices", "target": "Biosensors and Wearables", "weight": 23.21 }, { "source": "Vector Control", "target": "Fertilisers and Pesticides", "weight": 21.89 }, { "source": "Rehab Robotics", "target": "Prosthetics", "weight": 21.77 }, { "source": "Surgical Devices", "target": "Imaging Technology", "weight": 19.41 }, { "source": "Imaging Technology", "target": "Surgical Devices", "weight": 19.41 }, { "source": "Precision agriculture", "target": "Geographic Information Systems (GIS) and Remote Sensing", "weight": 19.3 }, { "source": "Autonomous Tractors and Drones", "target": "AMR Solutions", "weight": 19.13 }, { "source": "Supply Chain Management", "target": "AMR Solutions", "weight": 18.52 }, { "source": "Plant Tissue Culture", "target": "Advanced Biologics & Cell Therapies", "weight": 18.48 }, { "source": "Electronic Health Records", "target": "Biosensors and Wearables", "weight": 17.37 }, { "source": "Telemedicine", "target": "Electronic Health Records", "weight": 16.29 }, { "source": "Precision agriculture", "target": "Fertilisers and Pesticides", "weight": 15.87 }, { "source": "Surgical Devices", "target": "Prosthetics", "weight": 15.22 }, { "source": "Prosthetics", "target": "Surgical Devices", "weight": 15.22 }, { "source": "Vaccines", "target": "Advanced Biologics & Cell Therapies", "weight": 15.12 }, { "source": "Rehab Robotics", "target": "Biosensors and Wearables", "weight": 14.28 }, { "source": "Biosensors and Wearables", "target": "Rehab Robotics", "weight": 14.28 }, { "source": "Vaccines", "target": "DNA Technology - Genetically modified organisms (GMOs)", "weight": 14.02 }, { "source": "DNA Technology - Genetically modified organisms (GMOs)", "target": "Vaccines", "weight": 14.02 }, { "source": "Infectious Diseases Tests", "target": "DNA Technology - Genetically modified organisms (GMOs)", "weight": 13.6 }, { "source": "Digital Therapeutics", "target": "Biosensors and Wearables", "weight": 13.1 }, { "source": "Plant Tissue Culture", "target": "Fertilisers and Pesticides", "weight": 13.01 }, { "source": "Imaging Technology", "target": "Electronic Health Records", "weight": 12.83 }, { "source": "Electronic Health Records", "target": "Imaging Technology", "weight": 12.83 }, { "source": "Precision agriculture", "target": "Autonomous Tractors and Drones", "weight": 11.73 }, { "source": "DNA Technology - Genetically modified organisms (GMOs)", "target": "Breeding", "weight": 11.62 }, { "source": "Rehab Robotics", "target": "Digital Therapeutics", "weight": 11.46 }, { "source": "Digital Therapeutics", "target": "Rehab Robotics", "weight": 11.46 }, { "source": "Precision agriculture", "target": "Plant Tissue Culture", "weight": 10.92 }, { "source": "Plant Tissue Culture", "target": "Precision agriculture", "weight": 10.92 }, { "source": "Prosthetics", "target": "Biosensors and Wearables", "weight": 10.26 }, { "source": "Biosensors and Wearables", "target": "Prosthetics", "weight": 10.26 }, { "source": "Biosensors and Wearables", "target": "Air and Water Quality Sensors", "weight": 9.89 }, { "source": "Geographic Information Systems (GIS) and Remote Sensing", "target": "AMR Solutions", "weight": 9.16 }, { "source": "AMR Solutions", "target": "Geographic Information Systems (GIS) and Remote Sensing", "weight": 9.16 }, { "source": "Plant Tissue Culture", "target": "DNA Technology - Genetically modified organisms (GMOs)", "weight": 9.12 }, { "source": "DNA Technology - Genetically modified organisms (GMOs)", "target": "Plant Tissue Culture", "weight": 9.12 }, { "source": "Electronic Health Records", "target": "Digital Therapeutics", "weight": 8.77 }, { "source": "Digital Therapeutics", "target": "Electronic Health Records", "weight": 8.77 }, { "source": "Precision agriculture", "target": "AMR Solutions", "weight": 8.7 }, { "source": "AMR Solutions", "target": "Precision agriculture", "weight": 8.7 }, { "source": "Prosthetics", "target": "Digital Therapeutics", "weight": 8.61 }, { "source": "Digital Therapeutics", "target": "Prosthetics", "weight": 8.61 }, { "source": "Infectious Diseases Tests", "target": "Biosensors and Wearables", "weight": 8.48 }, { "source": "Telemedicine", "target": "Biosensors and Wearables", "weight": 8.46 }, { "source": "Biosensors and Wearables", "target": "Telemedicine", "weight": 8.46 }, { "source": "Imaging Technology", "target": "AMR Solutions", "weight": 8.36 }, { "source": "AMR Solutions", "target": "Imaging Technology", "weight": 8.36 }, { "source": "Imaging Technology", "target": "Digital Therapeutics", "weight": 7.74 }, { "source": "Digital Therapeutics", "target": "Imaging Technology", "weight": 7.74 }, { "source": "Breeding", "target": "Advanced Biologics & Cell Therapies", "weight": 7.71 }, { "source": "Advanced Biologics & Cell Therapies", "target": "Breeding", "weight": 7.71 }, { "source": "Rehab Robotics", "target": "Imaging Technology", "weight": 7.44 }, { "source": "Imaging Technology", "target": "Rehab Robotics", "weight": 7.44 }, { "source": "Water management", "target": "Climate-smart technologies", "weight": 7.35 }, { "source": "Digital Therapeutics", "target": "Air and Water Quality Sensors", "weight": 7.11 }, { "source": "Air and Water Quality Sensors", "target": "Digital Therapeutics", "weight": 7.11 }, { "source": "Telemedicine", "target": "Digital Therapeutics", "weight": 7 }, { "source": "Digital Therapeutics", "target": "Telemedicine", "weight": 7 }, { "source": "Imaging Technology", "target": "Air and Water Quality Sensors", "weight": 6.98 }, { "source": "Air and Water Quality Sensors", "target": "Imaging Technology", "weight": 6.98 }, { "source": "Infectious Diseases Tests", "target": "Advanced Biologics & Cell Therapies", "weight": 6.9 }, { "source": "Advanced Biologics & Cell Therapies", "target": "Infectious Diseases Tests", "weight": 6.9 }, { "source": "Fertilisers and Pesticides", "target": "Breeding", "weight": 6.89 }, { "source": "Breeding", "target": "Fertilisers and Pesticides", "weight": 6.89 }, { "source": "Water And Sanitation Hygiene Technologies", "target": "Air and Water Quality Sensors", "weight": 6.85 }, { "source": "Water management", "target": "Air and Water Quality Sensors", "weight": 6.78 }, { "source": "Water And Sanitation Hygiene Technologies", "target": "Climate-smart technologies", "weight": 6.78 }, { "source": "Climate-smart technologies", "target": "Water And Sanitation Hygiene Technologies", "weight": 6.78 }, { "source": "Air and Water Quality Sensors", "target": "Water management", "weight": 6.78 }, { "source": "Surgical Devices", "target": "AMR Solutions", "weight": 6.77 }, { "source": "AMR Solutions", "target": "Surgical Devices", "weight": 6.77 }, { "source": "Telemedicine", "target": "Imaging Technology", "weight": 6.1 }, { "source": "Imaging Technology", "target": "Telemedicine", "weight": 6.1 }, { "source": "Vaccines", "target": "Plant Tissue Culture", "weight": 5.99 }, { "source": "Plant Tissue Culture", "target": "Vaccines", "weight": 5.99 }, { "source": "Geographic Information Systems (GIS) and Remote Sensing", "target": "Autonomous Tractors and Drones", "weight": 5.86 }, { "source": "Autonomous Tractors and Drones", "target": "Geographic Information Systems (GIS) and Remote Sensing", "weight": 5.86 }, { "source": "Vector Control", "target": "Vaccines", "weight": 5.43 }, { "source": "Vaccines", "target": "Vector Control", "weight": 5.43 }, { "source": "DNA Technology - Genetically modified organisms (GMOs)", "target": "Biosensors and Wearables", "weight": 5.19 }, { "source": "Biosensors and Wearables", "target": "DNA Technology - Genetically modified organisms (GMOs)", "weight": 5.19 }, { "source": "Livestock technologies", "target": "DNA Technology - Genetically modified organisms (GMOs)", "weight": 5.05 }, { "source": "DNA Technology - Genetically modified organisms (GMOs)", "target": "Livestock technologies", "weight": 5.05 }, { "source": "Surgical Devices", "target": "Electronic Health Records", "weight": 5.02 }, { "source": "Electronic Health Records", "target": "Surgical Devices", "weight": 5.02 }, { "source": "Biosensors and Wearables", "target": "AMR Solutions", "weight": 4.94 }, { "source": "AMR Solutions", "target": "Biosensors and Wearables", "weight": 4.94 }, { "source": "Rehab Robotics", "target": "Electronic Health Records", "weight": 4.81 }, { "source": "Electronic Health Records", "target": "Rehab Robotics", "weight": 4.81 }, { "source": "Infectious Diseases Tests", "target": "Imaging Technology", "weight": 4.48 }, { "source": "Imaging Technology", "target": "Infectious Diseases Tests", "weight": 4.48 }, { "source": "Plant Tissue Culture", "target": "Breeding", "weight": 4.25 }, { "source": "Breeding", "target": "Plant Tissue Culture", "weight": 4.25 }, { "source": "Vector Control", "target": "Advanced Biologics & Cell Therapies", "weight": 4.23 }, { "source": "Precision agriculture", "target": "Climate-smart technologies", "weight": 4.23 }, { "source": "Climate-smart technologies", "target": "Precision agriculture", "weight": 4.23 }, { "source": "Advanced Biologics & Cell Therapies", "target": "Vector Control", "weight": 4.23 }, { "source": "Vector Control", "target": "DNA Technology - Genetically modified organisms (GMOs)", "weight": 4.17 }, { "source": "DNA Technology - Genetically modified organisms (GMOs)", "target": "Vector Control", "weight": 4.17 }, { "source": "Supply Chain Management", "target": "Climate-smart technologies", "weight": 2.06 }, { "source": "Climate-smart technologies", "target": "Supply Chain Management", "weight": 2.06 }];

        var svg = d3.select("svg.network");
        var svgNode = svg.node();
        var REFERENCE_WIDTH = 900;
        var BASE_RADIUS = 46;

        var extentX = d3.extent(nodes, function (d) { return d.x; });
        var extentY = d3.extent(nodes, function (d) { return d.y; });

        nodes.forEach(function (node) {
            node.dataX = node.x;
            node.dataY = node.y;
        });

        var width, height, nodeRadius, horizontalBounds;

        function recalcLayout() {
            width = (svgNode && svgNode.clientWidth) || window.innerWidth;
            height = (svgNode && svgNode.clientHeight) || Math.round(window.innerHeight * 0.9);
            nodeRadius = Math.max(20, Math.min(BASE_RADIUS, Math.round(BASE_RADIUS * (width / REFERENCE_WIDTH))));
            var padding = nodeRadius * 2;
            var horPadding = Math.max(10, nodeRadius * 0.25);

            var availableWidth = Math.max(width - padding * 2, padding);
            var availableHeight = Math.max(height - padding * 2, padding);

            var baseLeft = padding;
            var baseRight = padding + availableWidth;

            var minXBound = baseLeft + horPadding + nodeRadius;
            var maxXBound = baseRight - horPadding - nodeRadius;

            if (maxXBound <= minXBound) {
                var midpoint = (baseLeft + baseRight) / 2;
                minXBound = midpoint - 1;
                maxXBound = midpoint + 1;
            }

            horizontalBounds = { min: minXBound, max: maxXBound };

            var scaleX = d3.scaleLinear().domain(extentX).range([horizontalBounds.min, horizontalBounds.max]);
            var scaleY = d3.scaleLinear().domain(extentY).range([padding, padding + availableHeight]);

            nodes.forEach(function (node) {
                var targetX = clampX(scaleX(node.dataX));
                var targetY = scaleY(node.dataY);
                node.originalX = targetX;
                node.originalY = targetY;
            });

            svg.attr("viewBox", [0, 0, width, height]).attr("preserveAspectRatio", "xMidYMid meet");
        }

        function clampX(value) {
            return Math.max(horizontalBounds.min, Math.min(horizontalBounds.max, value));
        }

        recalcLayout();

        nodes.forEach(function (node) {
            node.x = node.originalX;
            node.y = node.originalY;
        });

        var container = svg.append("g");

        var zoomBehavior = d3.zoom()
            .scaleExtent([0.6, 3])
            .on("zoom", function (event) {
                container.attr("transform", event.transform);
            });

        svg.call(zoomBehavior);

        var nodeById = new Map(nodes.map(function (node) {
            return [node.id, node];
        }));

        var linkData = links.map(function (link) {
            return {
                source: nodeById.get(link.source),
                target: nodeById.get(link.target),
                weight: link.weight
            };
        }).filter(function (link) {
            return link.source && link.target;
        });

        var linkExtent = linkData.length ? d3.extent(linkData, function (d) { return d.weight || 1; }) : [1, 1];
        if (linkExtent[0] === linkExtent[1]) {
            linkExtent[1] = linkExtent[0] + 1;
        }

        var linkWidth = d3.scaleSqrt()
            .domain(linkExtent)
            .range([0.6, 4]);

        var link = container.append("g")
            .attr("stroke-linecap", "round")
            .selectAll("line")
            .data(linkData)
            .join("line")
            .attr("class", "link")
            .attr("stroke-width", function (d) { return linkWidth(d.weight || 1); });

        var adjacency = new Map();

        linkData.forEach(function (link) {
            var sourceId = link.source.id;
            var targetId = link.target.id;

            if (!adjacency.has(sourceId)) {
                adjacency.set(sourceId, new Set());
            }

            if (!adjacency.has(targetId)) {
                adjacency.set(targetId, new Set());
            }

            adjacency.get(sourceId).add(targetId);
            adjacency.get(targetId).add(sourceId);
        });

        var node = container.append("g")
            .selectAll("g")
            .data(nodes)
            .join("g")
            .attr("class", "node")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended))
            .on("mouseenter", highlightConnected)
            .on("mouseleave", resetHighlight);

        node.append("circle")
            .attr("r", nodeRadius)
            .attr("fill", function (d) { return d.color; });

        node.append("text")
            .attr("class", "node-label")
            .attr("fill", function (d) {
                return getContrastingTextColor(d.color);
            })
            .style("fill", function (d) {
                return getContrastingTextColor(d.color);
            })
            .call(wrapText, nodeRadius);

        node.append("title")
            .text(function (d) {
                return d.id + (d.parent ? " (" + d.parent + ")" : "");
            });

        renderLegend();

        var simulation = d3.forceSimulation(nodes)
            .alpha(0.9)
            .alphaDecay(0.09)
            .force("collide", d3.forceCollide(nodeRadius + 8).strength(0.95).iterations(4))
            .force("x", d3.forceX(function (d) { return d.originalX; }).strength(1))
            .force("y", d3.forceY(function (d) { return d.originalY; }).strength(1))
            .on("tick", ticked);

        var resizeTimer;
        window.addEventListener("resize", function () {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function () {
                recalcLayout();

                node.select("circle").attr("r", nodeRadius);
                node.select("text").call(wrapText, nodeRadius);

                simulation
                    .force("collide", d3.forceCollide(nodeRadius + 8).strength(0.95).iterations(4))
                    .force("x", d3.forceX(function (d) { return d.originalX; }).strength(1))
                    .force("y", d3.forceY(function (d) { return d.originalY; }).strength(1))
                    .alpha(0.8)
                    .restart();
            }, 150);
        });

        function ticked() {
            nodes.forEach(function (d) {
                d.x = clampX(d.x);
                if (d.fx != null) {
                    d.fx = clampX(d.fx);
                }
            });

            link
                .attr("x1", function (d) { return d.source.x; })
                .attr("y1", function (d) { return d.source.y; })
                .attr("x2", function (d) { return d.target.x; })
                .attr("y2", function (d) { return d.target.y; });

            node.attr("transform", function (d) {
                return "translate(" + d.x + "," + d.y + ")";
            });
        }

        function dragstarted(event, d) {
            if (!event.active) {
                simulation.alphaTarget(0.3).restart();
            }
            d.fx = clampX(d.x);
            d.fy = d.y;
        }

        function dragged(event, d) {
            var clampedX = clampX(event.x);
            d.fx = clampedX;
            d.fy = event.y;
            d.x = clampedX;
            d.y = event.y;
        }

        function dragended(event, d) {
            if (!event.active) {
                simulation.alphaTarget(0);
            }
            d.fx = null;
            d.fy = null;
        }

        function darkenColor(hexColor, factor) {
            factor = factor || 0.5;
            var hex = hexColor.trim().replace("#", "");
            if (hex.length === 3) {
                hex = hex.split("").map(function (ch) { return ch + ch; }).join("");
            }

            var r = parseInt(hex.slice(0, 2), 16);
            var g = parseInt(hex.slice(2, 4), 16);
            var b = parseInt(hex.slice(4, 6), 16);

            r = Math.round(r * factor);
            g = Math.round(g * factor);
            b = Math.round(b * factor);

            return "#" + [r, g, b].map(function (val) {
                var hexVal = val.toString(16);
                return hexVal.length === 1 ? "0" + hexVal : hexVal;
            }).join("");
        }

        function highlightConnected(event, nodeDatum) {
            var neighbors = adjacency.get(nodeDatum.id) || new Set();
            var activeIds = new Set(neighbors);
            activeIds.add(nodeDatum.id);

            node.each(function (d) {
                var isActive = activeIds.has(d.id);
                var nodeElement = d3.select(this);
                nodeElement
                    .classed("highlighted", isActive)
                    .classed("dimmed", !isActive);

                if (isActive) {
                    var darkerColor = darkenColor(d.color, 0.6);
                    nodeElement.select("circle").style("stroke", darkerColor);
                }
            });

            link.each(function (l) {
                var isActive = l.source.id === nodeDatum.id || l.target.id === nodeDatum.id;
                d3.select(this)
                    .classed("highlighted", isActive)
                    .classed("dimmed", !isActive);
            });
        }

        function resetHighlight() {
            node.classed("highlighted", false)
                .classed("dimmed", false)
                .select("circle").style("stroke", null);
            link.classed("highlighted", false)
                .classed("dimmed", false);
        }

        function renderLegend() {
            var legend = d3.select("#legend");
            if (legend.empty()) {
                return;
            }

            legend.attr("role", "list");

            var parentColorMap = new Map();
            nodes.forEach(function (node) {
                var parentName = node.parent || "Other";
                if (!parentColorMap.has(parentName)) {
                    parentColorMap.set(parentName, node.color || "#6c6f7d");
                }
            });

            var legendData = Array.from(parentColorMap, function (entry) {
                return { parent: entry[0], color: entry[1] };
            });

            var legendItems = legend.selectAll(".legend-item")
                .data(legendData, function (d) { return d.parent; });

            legendItems.exit().remove();

            var legendEnter = legendItems.enter()
                .append("div")
                .attr("class", "legend-item")
                .attr("role", "listitem");

            legendEnter.append("span")
                .attr("class", "legend-square");

            legendEnter.append("span")
                .attr("class", "legend-label");

            legendItems = legendEnter.merge(legendItems);

            legendItems.select(".legend-square")
                .style("background-color", function (d) { return d.color; });

            legendItems.select(".legend-label")
                .text(function (d) { return d.parent; });
        }

        function isColorDark(hexColor) {
            if (!hexColor) {
                return false;
            }

            var hex = hexColor.trim().replace("#", "");
            if (hex.length === 3) {
                hex = hex.split("").map(function (ch) { return ch + ch; }).join("");
            }

            if (hex.length !== 6) {
                return false;
            }

            var r = parseInt(hex.slice(0, 2), 16) / 255;
            var g = parseInt(hex.slice(2, 4), 16) / 255;
            var b = parseInt(hex.slice(4, 6), 16) / 255;

            var convert = function (channel) {
                return channel <= 0.03928 ? channel / 12.92 : Math.pow((channel + 0.055) / 1.055, 2.4);
            };

            var lum = 0.2126 * convert(r) + 0.7152 * convert(g) + 0.0722 * convert(b);
            return lum < 0.55;
        }

        function getContrastingTextColor(hexColor) {
            return isColorDark(hexColor) ? "#ffffff" : "#1b1d21";
        }

        function wrapText(selection, radius) {
            var diameter = radius * 2;
            var maxWidth = diameter * 0.85;
            var maxHeight = diameter * 0.85;
            var lineHeightMultiplier = 1.15;
            var minFontSize = 4;

            selection.each(function (d) {
                var text = d3.select(this);
                var label = (d.id || "").trim();

                text.selectAll("tspan").remove();
                text.text("");

                if (!label) {
                    return;
                }

                var words = label.split(/\s+/).filter(function (word) { return word.length; });
                if (!words.length) {
                    text.append("tspan")
                        .attr("x", 0)
                        .attr("y", 0)
                        .text(label);
                    return;
                }

                var maxFontSize = Math.min(13, radius * 0.45);
                var startingFontSize = Math.max(Math.round(maxFontSize), minFontSize);
                var bestFit = null;

                for (var fontSize = startingFontSize; fontSize >= minFontSize; fontSize -= 1) {
                    var layout = layoutLines(text, words, fontSize, lineHeightMultiplier, maxWidth);
                    bestFit = layout;
                    var totalHeight = layout.lines.length * layout.lineHeight;

                    if (layout.maxLineWidth <= maxWidth && totalHeight <= maxHeight) {
                        break;
                    }
                }

                if (!bestFit) {
                    bestFit = {
                        lines: [label],
                        fontSize: minFontSize,
                        lineHeight: Math.round(minFontSize * lineHeightMultiplier)
                    };
                }

                text.style("font-size", bestFit.fontSize + "px");
                text.selectAll("tspan").remove();

                var offset = (bestFit.lines.length - 1) * bestFit.lineHeight / 2;

                bestFit.lines.forEach(function (line, index) {
                    text.append("tspan")
                        .attr("x", 0)
                        .attr("y", -offset + index * bestFit.lineHeight)
                        .text(line);
                });
            });

            function layoutLines(text, words, fontSize, lineHeightMultiplier, maxWidth) {
                text.style("font-size", fontSize + "px");
                text.selectAll("tspan").remove();

                var lines = [];
                var currentLine = [];
                var maxLineWidth = 0;

                words.forEach(function (word) {
                    currentLine.push(word);
                    var tester = text.append("tspan")
                        .attr("x", 0)
                        .attr("y", 0)
                        .text(currentLine.join(" "));
                    var lineLength = tester.node().getComputedTextLength();
                    tester.remove();

                    if (lineLength > maxWidth && currentLine.length > 1) {
                        currentLine.pop();
                        var finalized = currentLine.join(" ");
                        var measureFinal = text.append("tspan")
                            .attr("x", 0)
                            .attr("y", 0)
                            .text(finalized);
                        var finalLength = measureFinal.node().getComputedTextLength();
                        measureFinal.remove();

                        lines.push(finalized);
                        maxLineWidth = Math.max(maxLineWidth, finalLength);

                        currentLine = [word];
                        var measureWord = text.append("tspan")
                            .attr("x", 0)
                            .attr("y", 0)
                            .text(word);
                        var wordLength = measureWord.node().getComputedTextLength();
                        measureWord.remove();
                        maxLineWidth = Math.max(maxLineWidth, wordLength);
                    } else {
                        maxLineWidth = Math.max(maxLineWidth, lineLength);
                    }
                });

                if (currentLine.length) {
                    var finalLine = currentLine.join(" ");
                    var finalTester = text.append("tspan")
                        .attr("x", 0)
                        .attr("y", 0)
                        .text(finalLine);
                    var finalLineLength = finalTester.node().getComputedTextLength();
                    finalTester.remove();

                    lines.push(finalLine);
                    maxLineWidth = Math.max(maxLineWidth, finalLineLength);
                }

                var lineHeight = Math.max(Math.round(fontSize * lineHeightMultiplier), Math.ceil(fontSize));

                return {
                    lines: lines,
                    fontSize: fontSize,
                    lineHeight: lineHeight,
                    maxLineWidth: maxLineWidth
                };
            }
        }

    </script>

</body>

</html>