<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <script src="https://www.paballand.com/js/d3plus-plot.v0.9.full.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, Helvetica, sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #chart {
            flex: 1 1 auto;
        }

        .legend {
            display: flex;
            justify-content: center;
            padding: 12px 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 0 24px;
            font-size: 14px;
        }

        .legend-item.interactive {
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .legend-item.inactive {
            opacity: 0.4;
        }

        .box {
            width: 14px;
            height: 14px;
            margin-right: 10px;
            border: none;
        }

        .pos {
            background: #2d7c2d;
        }

        .neg {
            background: #8B1A0F;
        }

        .tooltip-table {
            width: 100%;
        }

        .tooltip-table .data {
            text-align: right;
        }

        .tooltip-footer {
            opacity: .5;
        }

        tspan {
            font-family: "Helvetica", "Arial", sans-serif;
            font-size: 100px;
            font-style: oblique;
        }

        .custom-label {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 13px;
            fill: #000;
            opacity: 1;
            font-weight: normal;
            transition: opacity 0.4s ease, font-size 0.4s ease, font-weight 0.4s ease;
            pointer-events: none;
            transform-origin: center;
        }

        .custom-label.collision {
            opacity: 0.3;
        }

        .custom-label.hover {
            opacity: 1 !important;
            font-size: 16px !important;
            font-weight: bold !important;
        }

        .custom-label,
        text.custom-label {
            font-family: Arial, Helvetica, sans-serif !important;
            font-size: 13px;
            fill: #000 !important;
            stroke: none !important;
            font-weight: normal !important;
        }

        .connector-line {
            stroke: #000;
            stroke-width: 1px;
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="chart"></div>
        <div class="legend">
            <div class="legend-item"><span class="box" style="background: #669999;"></span><span>Advanced Industry &
                    Materials</span></div>
            <div class="legend-item"><span class="box" style="background: #800020;"></span><span>Health & Biotech</span>
            </div>
            <div class="legend-item"><span class="box" style="background: #365a94;"></span><span>Digital & AI</span>
            </div>
            <div class="legend-item"><span class="box" style="background: #8cab79;"></span><span>Energy & Climate</span>
            </div>
            <div class="legend-item"><span class="box" style="background: #e28f26;"></span><span>Security & Space</span>
            </div>
        </div>
    </div>
    <script>
        function median(v) {
            if (!v.length) throw new Error("empty");
            v = [...v].sort((a, b) => a - b);
            const h = Math.floor(v.length / 2);
            return v.length % 2 ? v[h] : (v[h - 1] + v[h]) / 2;
        }

        function truncateText(text, maxLength = 35) {
            if (text.length <= maxLength) {
                return text;
            }
            return text.substring(0, maxLength) + "...";
        }

        function rectanglesOverlap(rect1, rect2) {
            return !(rect1.x + rect1.width < rect2.x ||
                rect2.x + rect2.width < rect1.x ||
                rect1.y + rect1.height < rect2.y ||
                rect2.y + rect2.height < rect1.y);
        }

        function getPositionOptions(centerX, centerY, radius, padding = 8) {
            const card = [
                { name: 'right', x: centerX + radius + padding, y: centerY + 5, anchor: 'start' },
                { name: 'left', x: centerX - radius - padding, y: centerY + 5, anchor: 'end' },
                { name: 'below', x: centerX, y: centerY + radius + padding + 10, anchor: 'middle' },
                { name: 'above', x: centerX, y: centerY - radius - padding, anchor: 'middle' }
            ];

            const diagPad = padding;
            const diagOffset = (radius + diagPad) * 0.707;
            const extraX = 4;

            const diag = [
                { name: 'top-right', x: centerX + diagOffset + extraX, y: centerY - diagOffset, anchor: 'start' },
                { name: 'bottom-right', x: centerX + diagOffset + extraX, y: centerY + diagOffset + 5, anchor: 'start' },
                { name: 'bottom-left', x: centerX - diagOffset - extraX, y: centerY + diagOffset + 5, anchor: 'end' },
                { name: 'top-left', x: centerX - diagOffset - extraX, y: centerY - diagOffset, anchor: 'end' }
            ];

            return [...card, ...diag];
        }

        function hasCollision(textElement, obstacles, ignoreCircle) {
            try {
                const rawBBox = textElement.getBBox();
                const pad = 2;
                const textBBox = {
                    x: rawBBox.x + pad,
                    y: rawBBox.y + pad,
                    width: Math.max(0, rawBBox.width - pad * 2),
                    height: Math.max(0, rawBBox.height - pad * 2)
                };

                for (const obs of obstacles) {
                    if (obs.isCircle && obs.ref === ignoreCircle) continue;

                    if (rectanglesOverlap(textBBox, obs)) {
                        return true;
                    }
                }
                return false;
            } catch (e) {
                return false;
            }
        }

        function isOutOfBounds(textElement, bounds) {
            if (!bounds) return false;
            try {
                const bbox = textElement.getBBox();
                const margin = 5;
                if (bbox.x < bounds.x + margin ||
                    bbox.y < bounds.y + margin ||
                    (bbox.x + bbox.width) > (bounds.x + bounds.width - margin) ||
                    (bbox.y + bbox.height) > (bounds.y + bounds.height - margin)) {
                    return true;
                }
                return false;
            } catch (e) {
                return false;
            }
        }

        function findBestPosition(textElement, centerX, centerY, radius, obstacles, fullText, bounds, currentCircle, manualDirection) {
            const positions = getPositionOptions(centerX, centerY, radius);
            const truncatedText = truncateText(fullText, 35);

            if (manualDirection !== undefined && manualDirection !== null) {
                const directionMap = {
                    0: 'right',
                    1: 'bottom-right',
                    2: 'below',
                    3: 'bottom-left',
                    4: 'left',
                    5: 'top-left',
                    6: 'above',
                    7: 'top-right'
                };

                const dir = directionMap[manualDirection];
                const manualPos = positions.find(p => p.name === dir);
                if (manualPos) {
                    textElement.textContent = fullText;
                    textElement.setAttribute('x', manualPos.x);
                    textElement.setAttribute('y', manualPos.y);
                    textElement.setAttribute('text-anchor', manualPos.anchor);

                    const isColliding = hasCollision(textElement, obstacles, currentCircle);
                    return { ...manualPos, text: fullText, hasCollision: isColliding, isManual: true };
                }
            }

            let hasCollisionWithFull = false;

            textElement.textContent = fullText;
            for (const pos of positions) {
                textElement.setAttribute('x', pos.x);
                textElement.setAttribute('y', pos.y);
                textElement.setAttribute('text-anchor', pos.anchor);

                if (!hasCollision(textElement, obstacles, currentCircle) && !isOutOfBounds(textElement, bounds)) {
                    return { ...pos, text: fullText, hasCollision: false };
                }
            }

            hasCollisionWithFull = true;

            hasCollisionWithFull = true;

            textElement.textContent = truncatedText;
            for (const pos of positions) {
                textElement.setAttribute('x', pos.x);
                textElement.setAttribute('y', pos.y);
                textElement.setAttribute('text-anchor', pos.anchor);

                if (!hasCollision(textElement, obstacles, currentCircle) && !isOutOfBounds(textElement, bounds)) {
                    return { ...pos, text: truncatedText, hasCollision: hasCollisionWithFull };
                }
            }

            return { ...positions[0], text: truncatedText, hasCollision: true };
        }

        function getBoundData(element) {
            if (element.__data__) {
                return element.__data__;
            }

            let parent = element.parentElement;
            while (parent) {
                if (parent.__data__) {
                    return parent.__data__;
                }
                parent = parent.parentElement;
            }

            return null;
        }

        function findMatchingDataPoint(circle) {
            const bound = circle.__data__ || d3.select(circle).datum();
            if (bound) return bound;
            console.warn('No data bound to circle:', circle);
            return null;
        }

        var data =

            [
                {
                    "domain": "Advanced Manufacturing",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 19.32,
                    "reldens.op": 29.98,
                    "y": 61,
                    "reldens.reg": 31.32,
                    "parent": "Advanced Industry & Materials",
                    "color": "#669999",
                    "rank.reg": 18,
                    "rank.op": 12,
                    "rank.cb": 12,
                    "rank": 42,
                    "rank.rs": 25.39,
                    "id": "Advanced Manufacturing",
                    "x": 25.39,
                    "value": 1
                },
                {
                    "domain": "Advanced Materials",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 18.59,
                    "reldens.op": 46.31,
                    "y": 61.88,
                    "reldens.reg": 53.75,
                    "parent": "Advanced Industry & Materials",
                    "color": "#669999",
                    "rank.reg": 25,
                    "rank.op": 20,
                    "rank.cb": 11,
                    "rank": 56,
                    "rank.rs": 39.9,
                    "id": "Advanced Materials",
                    "x": 39.9,
                    "value": 1
                },
                {
                    "domain": "Advanced Therapy Medicinal Products (ATMP)",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 66.37,
                    "reldens.op": 82.53,
                    "y": 64.79,
                    "reldens.reg": 91.88,
                    "parent": "Health & Biotech",
                    "color": "#800020",
                    "rank.reg": 37,
                    "rank.op": 34,
                    "rank.cb": 36,
                    "rank": 107,
                    "rank.rs": 92.75,
                    "id": "Advanced Therapy Medicinal Products (ATMP)",
                    "x": 92.75,
                    "value": 1,
                    "labelDirection": 5
                },
                {
                    "domain": "Artificial Intelligence",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 24.73,
                    "reldens.op": 38.93,
                    "y": 76.09,
                    "reldens.reg": 12.19,
                    "parent": "Digital & AI",
                    "color": "#365a94",
                    "rank.reg": 8,
                    "rank.op": 14,
                    "rank.cb": 20,
                    "rank": 42,
                    "rank.rs": 25.39,
                    "id": "Artificial Intelligence",
                    "x": 25.39,
                    "value": 1
                },
                {
                    "domain": "Autonomous Robots",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 19.74,
                    "reldens.op": 24.29,
                    "y": 68.39,
                    "reldens.reg": 12.85,
                    "parent": "Advanced Industry & Materials",
                    "color": "#669999",
                    "rank.reg": 10,
                    "rank.op": 7,
                    "rank.cb": 13,
                    "rank": 30,
                    "rank.rs": 12.95,
                    "id": "Autonomous Robots",
                    "x": 12.95,
                    "value": 1
                },
                {
                    "domain": "Bioinformatics",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 34.38,
                    "reldens.op": 77.19,
                    "y": 71.15,
                    "reldens.reg": 76.89,
                    "parent": "Health & Biotech",
                    "color": "#800020",
                    "rank.reg": 32,
                    "rank.op": 32,
                    "rank.cb": 27,
                    "rank": 91,
                    "rank.rs": 76.17,
                    "id": "Bioinformatics",
                    "x": 76.17,
                    "value": 1
                },
                {
                    "domain": "Biomanufacturing",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 75.96,
                    "reldens.op": 75.98,
                    "y": 62.49,
                    "reldens.reg": 88.67,
                    "parent": "Health & Biotech",
                    "color": "#800020",
                    "rank.reg": 34,
                    "rank.op": 30,
                    "rank.cb": 37,
                    "rank": 101,
                    "rank.rs": 86.53,
                    "id": "Biomanufacturing",
                    "x": 86.53,
                    "value": 1
                },
                {
                    "domain": "Biotechnology",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 49.58,
                    "reldens.op": 82.97,
                    "y": 62.73,
                    "reldens.reg": 84.71,
                    "parent": "Health & Biotech",
                    "color": "#800020",
                    "rank.reg": 33,
                    "rank.op": 35,
                    "rank.cb": 32,
                    "rank": 100,
                    "rank.rs": 85.49,
                    "id": "Biotechnology",
                    "x": 85.49,
                    "value": 1,
                    "labelDirection": 3
                },
                {
                    "domain": "Carbon Capture & Storage",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 11.27,
                    "reldens.op": 43.98,
                    "y": 52.8,
                    "reldens.reg": 55.35,
                    "parent": "Energy & Climate",
                    "color": "#8cab79",
                    "rank.reg": 26,
                    "rank.op": 18,
                    "rank.cb": 1,
                    "rank": 45,
                    "rank.rs": 28.5,
                    "id": "Carbon Capture & Storage",
                    "x": 28.5,
                    "value": 1
                },
                {
                    "domain": "Cloud and Edge Computing",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 20.24,
                    "reldens.op": 12.32,
                    "y": 74.04,
                    "reldens.reg": 6,
                    "parent": "Digital & AI",
                    "color": "#365a94",
                    "rank.reg": 1,
                    "rank.op": 3,
                    "rank.cb": 14.5,
                    "rank": 18.5,
                    "rank.rs": 1.04,
                    "id": "Cloud and Edge Computing",
                    "x": 1.04,
                    "value": 1
                },
                {
                    "domain": "Cybersecurity",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 45.44,
                    "reldens.op": 20.92,
                    "y": 76.37,
                    "reldens.reg": 8.81,
                    "parent": "Security & Space",
                    "color": "#e28f26",
                    "rank.reg": 4,
                    "rank.op": 5,
                    "rank.cb": 30,
                    "rank": 39,
                    "rank.rs": 22.28,
                    "id": "Cybersecurity",
                    "x": 22.28,
                    "value": 1
                },
                {
                    "domain": "Defence Technologies",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 20.24,
                    "reldens.op": 9.76,
                    "y": 40.3,
                    "reldens.reg": 7.34,
                    "parent": "Security & Space",
                    "color": "#e28f26",
                    "rank.reg": 2,
                    "rank.op": 1,
                    "rank.cb": 14.5,
                    "rank": 17.5,
                    "rank.rs": 0,
                    "id": "Defence Technologies",
                    "x": 0,
                    "value": 1
                },
                {
                    "domain": "Drones",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 25.36,
                    "reldens.op": 9.86,
                    "y": 65.97,
                    "reldens.reg": 13.94,
                    "parent": "Security & Space",
                    "color": "#e28f26",
                    "rank.reg": 11,
                    "rank.op": 2,
                    "rank.cb": 22,
                    "rank": 35,
                    "rank.rs": 18.13,
                    "id": "Drones",
                    "x": 18.13,
                    "value": 1
                },
                {
                    "domain": "Food Technology",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 38.65,
                    "reldens.op": 76.91,
                    "y": 54.02,
                    "reldens.reg": 75.96,
                    "parent": "Advanced Industry & Materials",
                    "color": "#669999",
                    "rank.reg": 31,
                    "rank.op": 31,
                    "rank.cb": 28,
                    "rank": 90,
                    "rank.rs": 75.13,
                    "id": "Food Technology",
                    "x": 75.13,
                    "value": 1
                },
                {
                    "domain": "Generative AI",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 26.82,
                    "reldens.op": 51.74,
                    "y": 73.1,
                    "reldens.reg": 11.62,
                    "parent": "Digital & AI",
                    "color": "#365a94",
                    "rank.reg": 7,
                    "rank.op": 22,
                    "rank.cb": 24,
                    "rank": 53,
                    "rank.rs": 36.79,
                    "id": "Generative AI",
                    "x": 36.79,
                    "value": 1
                },
                {
                    "domain": "Genomics & Gene Editing",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 43.04,
                    "reldens.op": 83.22,
                    "y": 63.83,
                    "reldens.reg": 89.68,
                    "parent": "Health & Biotech",
                    "color": "#800020",
                    "rank.reg": 35,
                    "rank.op": 36,
                    "rank.cb": 29,
                    "rank": 100,
                    "rank.rs": 85.49,
                    "id": "Genomics & Gene Editing",
                    "x": 85.49,
                    "value": 1,
                    "labelDirection": 4
                },
                {
                    "domain": "High-Performance Computing (HPC)",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 15.93,
                    "reldens.op": 27.92,
                    "y": 70.93,
                    "reldens.reg": 19.44,
                    "parent": "Digital & AI",
                    "color": "#365a94",
                    "rank.reg": 15,
                    "rank.op": 11,
                    "rank.cb": 5,
                    "rank": 31,
                    "rank.rs": 13.99,
                    "id": "High-Performance Computing (HPC)",
                    "x": 13.99,
                    "value": 1,
                    "labelDirection": 0
                },
                {
                    "domain": "Immunotherapy",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 62.88,
                    "reldens.op": 74.61,
                    "y": 62.72,
                    "reldens.reg": 90.67,
                    "parent": "Health & Biotech",
                    "color": "#800020",
                    "rank.reg": 36,
                    "rank.op": 28,
                    "rank.cb": 34,
                    "rank": 98,
                    "rank.rs": 83.42,
                    "id": "Immunotherapy",
                    "x": 83.42,
                    "value": 1
                },
                {
                    "domain": "Internet of Things (IOT)",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 22,
                    "reldens.op": 21.47,
                    "y": 76.38,
                    "reldens.reg": 12.41,
                    "parent": "Digital & AI",
                    "color": "#365a94",
                    "rank.reg": 9,
                    "rank.op": 6,
                    "rank.cb": 17,
                    "rank": 32,
                    "rank.rs": 15.03,
                    "id": "Internet of Things (IOT)",
                    "x": 15.03,
                    "value": 1
                },
                {
                    "domain": "Medical Devices",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 33.86,
                    "reldens.op": 60.75,
                    "y": 57.68,
                    "reldens.reg": 33.58,
                    "parent": "Health & Biotech",
                    "color": "#800020",
                    "rank.reg": 21,
                    "rank.op": 24,
                    "rank.cb": 26,
                    "rank": 71,
                    "rank.rs": 55.44,
                    "id": "Medical Devices",
                    "x": 55.44,
                    "value": 1
                },
                {
                    "domain": "Microelectronics",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 22.67,
                    "reldens.op": 49.84,
                    "y": 69.9,
                    "reldens.reg": 29.17,
                    "parent": "Digital & AI",
                    "color": "#365a94",
                    "rank.reg": 17,
                    "rank.op": 21,
                    "rank.cb": 19,
                    "rank": 57,
                    "rank.rs": 40.93,
                    "id": "Microelectronics",
                    "x": 40.93,
                    "value": 1
                },
                {
                    "domain": "mRNA Technology",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 76.16,
                    "reldens.op": 86.43,
                    "y": 67.09,
                    "reldens.reg": 95.67,
                    "parent": "Health & Biotech",
                    "color": "#800020",
                    "rank.reg": 38,
                    "rank.op": 38,
                    "rank.cb": 38,
                    "rank": 114,
                    "rank.rs": 100,
                    "id": "mRNA Technology",
                    "x": 100,
                    "value": 1,
                    "labelDirection": 5
                },
                {
                    "domain": "Nanotechnologies",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 16.22,
                    "reldens.op": 61.68,
                    "y": 60.84,
                    "reldens.reg": 60.72,
                    "parent": "Advanced Industry & Materials",
                    "color": "#669999",
                    "rank.reg": 27,
                    "rank.op": 26,
                    "rank.cb": 6,
                    "rank": 59,
                    "rank.rs": 43.01,
                    "id": "Nanotechnologies",
                    "x": 43.01,
                    "value": 1
                },
                {
                    "domain": "Natural Language Processing",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 26.16,
                    "reldens.op": 26.85,
                    "y": 75.44,
                    "reldens.reg": 10.72,
                    "parent": "Digital & AI",
                    "color": "#365a94",
                    "rank.reg": 6,
                    "rank.op": 10,
                    "rank.cb": 23,
                    "rank": 39,
                    "rank.rs": 22.28,
                    "id": "Natural Language Processing",
                    "x": 22.28,
                    "value": 1
                },
                {
                    "domain": "Nuclear Energy",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 16.86,
                    "reldens.op": 39.46,
                    "y": 53.83,
                    "reldens.reg": 40.08,
                    "parent": "Energy & Climate",
                    "color": "#8cab79",
                    "rank.reg": 22,
                    "rank.op": 16,
                    "rank.cb": 8,
                    "rank": 46,
                    "rank.rs": 29.53,
                    "id": "Nuclear Energy",
                    "x": 29.53,
                    "value": 1
                },
                {
                    "domain": "Pharmaceuticals",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 64.55,
                    "reldens.op": 74.74,
                    "y": 57.98,
                    "reldens.reg": 74.74,
                    "parent": "Health & Biotech",
                    "color": "#800020",
                    "rank.reg": 29,
                    "rank.op": 29,
                    "rank.cb": 35,
                    "rank": 93,
                    "rank.rs": 78.24,
                    "id": "Pharmaceuticals",
                    "x": 78.24,
                    "value": 1
                },
                {
                    "domain": "Photonics",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 14.78,
                    "reldens.op": 44,
                    "y": 71.29,
                    "reldens.reg": 31.61,
                    "parent": "Digital & AI",
                    "color": "#365a94",
                    "rank.reg": 19,
                    "rank.op": 19,
                    "rank.cb": 4,
                    "rank": 42,
                    "rank.rs": 25.39,
                    "id": "Photonics",
                    "x": 25.39,
                    "value": 1
                },
                {
                    "domain": "Precision Medicine",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 54.91,
                    "reldens.op": 83.97,
                    "y": 65.67,
                    "reldens.reg": 73.59,
                    "parent": "Health & Biotech",
                    "color": "#800020",
                    "rank.reg": 28,
                    "rank.op": 37,
                    "rank.cb": 33,
                    "rank": 98,
                    "rank.rs": 83.42,
                    "id": "Precision Medicine",
                    "x": 83.42,
                    "value": 1,
                    "labelDirection": 6
                },
                {
                    "domain": "Quantum computing",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 16.89,
                    "reldens.op": 12.63,
                    "y": 71.3,
                    "reldens.reg": 14.36,
                    "parent": "Digital & AI",
                    "color": "#365a94",
                    "rank.reg": 12,
                    "rank.op": 4,
                    "rank.cb": 9,
                    "rank": 25,
                    "rank.rs": 7.77,
                    "id": "Quantum computing",
                    "x": 7.77,
                    "value": 1
                },
                {
                    "domain": "Regenerative Medicine",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 13.9,
                    "reldens.op": 77.31,
                    "y": 58.91,
                    "reldens.reg": 75.11,
                    "parent": "Health & Biotech",
                    "color": "#800020",
                    "rank.reg": 30,
                    "rank.op": 33,
                    "rank.cb": 3,
                    "rank": 66,
                    "rank.rs": 50.26,
                    "id": "Regenerative Medicine",
                    "x": 50.26,
                    "value": 1
                },
                {
                    "domain": "Robotics",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 22.43,
                    "reldens.op": 24.36,
                    "y": 61.73,
                    "reldens.reg": 16.46,
                    "parent": "Advanced Industry & Materials",
                    "color": "#669999",
                    "rank.reg": 13,
                    "rank.op": 8,
                    "rank.cb": 18,
                    "rank": 39,
                    "rank.rs": 22.28,
                    "id": "Robotics",
                    "x": 22.28,
                    "value": 1
                },
                {
                    "domain": "Semiconductors",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 32.14,
                    "reldens.op": 61.34,
                    "y": 73.83,
                    "reldens.reg": 32.81,
                    "parent": "Digital & AI",
                    "color": "#365a94",
                    "rank.reg": 20,
                    "rank.op": 25,
                    "rank.cb": 25,
                    "rank": 70,
                    "rank.rs": 54.4,
                    "id": "Semiconductors",
                    "x": 54.4,
                    "value": 1
                },
                {
                    "domain": "Sensor Technologies",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 20.53,
                    "reldens.op": 55.55,
                    "y": 62.66,
                    "reldens.reg": 23.44,
                    "parent": "Advanced Industry & Materials",
                    "color": "#669999",
                    "rank.reg": 16,
                    "rank.op": 23,
                    "rank.cb": 16,
                    "rank": 55,
                    "rank.rs": 38.86,
                    "id": "Sensor Technologies",
                    "x": 38.86,
                    "value": 1
                },
                {
                    "domain": "Smart Grids",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 45.63,
                    "reldens.op": 39.21,
                    "y": 68.91,
                    "reldens.reg": 8.96,
                    "parent": "Energy & Climate",
                    "color": "#8cab79",
                    "rank.reg": 5,
                    "rank.op": 15,
                    "rank.cb": 31,
                    "rank": 51,
                    "rank.rs": 34.72,
                    "id": "Smart Grids",
                    "x": 34.72,
                    "value": 1
                },
                {
                    "domain": "Smart Materials",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 16.38,
                    "reldens.op": 42.79,
                    "y": 59.57,
                    "reldens.reg": 43.13,
                    "parent": "Advanced Industry & Materials",
                    "color": "#669999",
                    "rank.reg": 23,
                    "rank.op": 17,
                    "rank.cb": 7,
                    "rank": 47,
                    "rank.rs": 30.57,
                    "id": "Smart Materials",
                    "x": 30.57,
                    "value": 1
                },
                {
                    "domain": "Space technologies",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 12.44,
                    "reldens.op": 36.11,
                    "y": 72.69,
                    "reldens.reg": 8.48,
                    "parent": "Security & Space",
                    "color": "#e28f26",
                    "rank.reg": 3,
                    "rank.op": 13,
                    "rank.cb": 2,
                    "rank": 18,
                    "rank.rs": 0.52,
                    "id": "Space technologies",
                    "x": 0.52,
                    "value": 1
                },
                {
                    "domain": "Waste Management",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 17.71,
                    "reldens.op": 65.7,
                    "y": 50.11,
                    "reldens.reg": 52.47,
                    "parent": "Energy & Climate",
                    "color": "#8cab79",
                    "rank.reg": 24,
                    "rank.op": 27,
                    "rank.cb": 10,
                    "rank": 61,
                    "rank.rs": 45.08,
                    "id": "Waste Management",
                    "x": 45.08,
                    "value": 1
                },
                {
                    "domain": "Wind Energy",
                    "geo": "Flanders (BE2)",
                    "reldens.cb": 25.09,
                    "reldens.op": 25.49,
                    "y": 46.66,
                    "reldens.reg": 16.81,
                    "parent": "Energy & Climate",
                    "color": "#8cab79",
                    "rank.reg": 14,
                    "rank.op": 9,
                    "rank.cb": 21,
                    "rank": 44,
                    "rank.rs": 27.46,
                    "id": "Wind Energy",
                    "x": 27.46,
                    "value": 1
                }
            ];

        const xVals = data.map(d => d.x);
        const yVals = data.map(d => d.y);
        const medianX = median(xVals);
        const medianY = median(yVals);
        const xDomain = [-5, 105];
        const minY = Math.min(...yVals) - 5;
        const maxY = Math.max(...yVals) + 5;

        let customLabels = [];
        let isUpdating = false;
        let hoveringElements = new Set();
        let viz;
        let activeFilters = new Set();
        const allData = data;

        renderLegend();

        function renderLegend() {
            const legendEl = document.querySelector('.legend');
            legendEl.innerHTML = '';

            if (allData.length > 0 && allData[0].parent) {
                const groups = {};
                allData.forEach(d => {
                    if (!groups[d.parent]) groups[d.parent] = d.color;
                });

                Object.keys(groups).forEach(parent => {
                    const color = groups[parent];
                    const item = document.createElement('div');
                    item.className = 'legend-item interactive';
                    item.innerHTML = `<span class="box" style="background: ${color};"></span><span>${parent}</span>`;
                    item.onclick = () => toggleFilter(parent, item);
                    legendEl.appendChild(item);
                });
            } else {
                legendEl.innerHTML = `
            <div class="legend-item"><span class="box pos"></span><span>Investment RCA &gt; 1</span></div>
            <div class="legend-item"><span class="box neg"></span><span>Investment RCA &lt; 1</span></div>`;
            }
        }

        function toggleFilter(parent, element) {
            if (activeFilters.has(parent)) {
                activeFilters.delete(parent);
                element.classList.remove('inactive');
            } else {
                activeFilters.add(parent);
                element.classList.add('inactive');
            }

            const elementParent = parent;
            const legends = document.querySelectorAll('.legend-item');
            legends.forEach(l => {
                if (l.innerText.includes(elementParent)) {
                    if (activeFilters.has(elementParent)) {
                        l.classList.add('inactive');
                    } else {
                        l.classList.remove('inactive');
                    }
                }
            });

            const filtered = (activeFilters.size === 0)
                ? allData
                : allData.filter(d => !activeFilters.has(d.parent));
            customLabels.forEach(l => {
                if (l.text) l.text.remove();
                if (l.line) l.line.remove();
            });
            customLabels = [];

            viz.data(filtered).render();

            setTimeout(() => {
                initializeCustomLabels();
            }, 500);
        }

        viz = new d3plus.Plot()
            .select("#chart")
            .data(data)
            .annotations([{
                data: [{ id: "Trend", x: medianX, y: minY },
                { id: "Trend", x: medianX, y: maxY },
                { id: "Baseline", x: xDomain[0], y: medianY },
                { id: "Baseline", x: xDomain[1], y: medianY }], shape: "Line", stroke: "#c3c3c3", strokeDasharray: "10", strokeWidth: 2
            }])
            .groupBy(["parent", "id"])
            .tooltipConfig({
                body: d => `<table class='tooltip-table'>
      <tr><td class='title'>Relatedness Density:</td><td class='data'>${d.x}</td></tr>
      <tr><td class='title'>Complexity:</td><td class='data'>${d.y}</td></tr>
      <tr><td class='title'>RCA:</td><td class='data'>${d.rca}</td></tr>
      <tr><td class='title'>ID:</td><td class='data'>${d.id}</td></tr>
    </table>`,
                title: d => d.id
            })
            .size("value")
            .sizeMin(12.75)
            .sizeMax(12.75)
            .color("color")
            .label("")
            .shapeConfig({
                Circle: {
                    labelConfig: { fontSize: 0 }
                }
            })
            .yConfig({
                title: "Technological Complexity",
                titleConfig: { fontSize: () => 16 },
                gridConfig: { stroke: "transparent" },
                shapeConfig: { labelConfig: { fontSize: () => 16 } }
            })
            .yDomain([minY, maxY])
            .xDomain(xDomain)
            .xConfig({
                title: "Technological Relatedness Density",
                titleConfig: { fontSize: () => 16 },
                gridConfig: { stroke: "transparent" },
                shapeConfig: { labelConfig: { fontSize: () => 16 } }
            })
            .legend(false)
            .downloadButton(false)
            .render();

        setTimeout(() => {
            initializeCustomLabels();
            startPositionUpdater();
        }, 500);

        function initializeCustomLabels() {
            const svg = document.querySelector('#chart svg');
            if (!svg) {
                setTimeout(initializeCustomLabels, 100);
                return;
            }

            const circles = svg.querySelectorAll('circle');
            console.log('Found circles:', circles.length);

            customLabels.forEach(l => {
                if (l.text) l.text.remove();
                if (l.line) l.line.remove();
            });
            customLabels = [];
            document.querySelectorAll('.custom-label, .connector-line').forEach(e => e.remove());
            if (hoveringElements) hoveringElements.clear();

            circles.forEach((circle, index) => {
                let matchingData = findMatchingDataPoint(circle);

                if (matchingData) {
                    const originalData = data.find(d =>
                        d.id === matchingData.id ||
                        d.domain === matchingData.domain ||
                        (d.parent + "_" + d.id) === matchingData.id
                    );
                    if (originalData) {
                        matchingData = originalData;
                    }

                    console.log('Circle', index, 'matched to data:', matchingData.id, 'Direction:', matchingData.labelDirection);

                    const fullText = matchingData.domain || matchingData.id;

                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('class', 'custom-label');
                    text.setAttribute('data-id', matchingData.id);
                    text.setAttribute('text-anchor', 'start');
                    text.setAttribute('font-family', 'Arial, Helvetica, sans-serif');
                    text.setAttribute('font-size', '13');
                    if (matchingData.labelColor) {
                        text.setAttribute('fill', matchingData.labelColor);
                        text.style.fill = matchingData.labelColor;
                    } else {
                        text.setAttribute('fill', '#000');
                    }
                    text.setAttribute('font-weight', 'normal');
                    text.textContent = fullText;

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('class', 'connector-line');

                    svg.appendChild(line);
                    svg.appendChild(text);

                    customLabels.push({
                        circle: circle,
                        text: text,
                        line: line,
                        data: matchingData,
                        fullText: fullText,
                        defaultText: fullText,
                        savedPosition: null
                    });

                    circle.addEventListener('mouseenter', () => {
                        hoveringElements.add(text);

                        const labelData = customLabels.find(l => l.circle === circle);
                        if (labelData) {
                            labelData.savedPosition = {
                                x: text.getAttribute('x'),
                                y: text.getAttribute('y'),
                                anchor: text.getAttribute('text-anchor'),
                                content: text.textContent
                            };
                        }

                        text.classList.add('hover');
                        text.textContent = fullText;

                        console.log('Hovering over:', matchingData.id);
                    });

                    circle.addEventListener('mouseleave', () => {
                        hoveringElements.delete(text);

                        text.classList.remove('hover');

                        const labelData = customLabels.find(l => l.circle === circle);
                        if (labelData && labelData.savedPosition) {
                            text.setAttribute('x', labelData.savedPosition.x);
                            text.setAttribute('y', labelData.savedPosition.y);
                            text.setAttribute('text-anchor', labelData.savedPosition.anchor);
                            text.textContent = labelData.savedPosition.content;
                        }
                    });
                } else {
                    console.log('Circle', index, 'could not be matched to data');
                }
            });

            updateLabelPositions();
        }

        function updateLabelPositions() {
            if (isUpdating) return;
            isUpdating = true;

            const svg = document.querySelector('#chart svg');
            if (!svg) {
                isUpdating = false;
                return;
            }

            const chartDiv = document.getElementById('chart');
            const width = chartDiv ? chartDiv.clientWidth : window.innerWidth;
            let currentFontSize = 13;
            if (width < 600) currentFontSize = 9;
            else if (width < 900) currentFontSize = 11;

            customLabels.forEach(({ text }) => {
                if (text) {
                    text.setAttribute('font-size', currentFontSize);
                    text.style.fontSize = currentFontSize + 'px';
                }
            });

            const circlePositions = [];

            customLabels.forEach(({ circle, text }) => {
                if (circle && text) {
                    const bbox = circle.getBoundingClientRect();
                    const svgRect = svg.getBoundingClientRect();

                    const svgPoint = svg.createSVGPoint();
                    svgPoint.x = bbox.left + bbox.width / 2 - svgRect.left;
                    svgPoint.y = bbox.top + bbox.height / 2 - svgRect.top;

                    const screenCTM = svg.getScreenCTM();
                    if (screenCTM) {
                        const svgCoords = svgPoint.matrixTransform(screenCTM.inverse());
                        circlePositions.push({
                            circle: circle,
                            coords: svgCoords
                        });
                    }
                }
            });

            const obstacles = circlePositions.map(c => {
                const r = parseFloat(c.circle.getAttribute('r')) || 7.5;
                return {
                    x: c.coords.x - r,
                    y: c.coords.y - r,
                    width: r * 2,
                    height: r * 2,
                    isCircle: true,
                    ref: c.circle
                };
            });

            let bounds = null;
            if (svg) {
                try {
                    const screenCTM = svg.getScreenCTM();
                    if (screenCTM) {
                        const inverseCTM = screenCTM.inverse();
                        const rect = svg.getBoundingClientRect();

                        const p1 = svg.createSVGPoint();
                        p1.x = rect.left;
                        p1.y = rect.top;
                        const min = p1.matrixTransform(inverseCTM);

                        const p2 = svg.createSVGPoint();
                        p2.x = rect.right;
                        p2.y = rect.bottom;
                        const max = p2.matrixTransform(inverseCTM);

                        bounds = {
                            x: min.x,
                            y: min.y,
                            width: max.x - min.x,
                            height: max.y - min.y
                        };
                    }
                } catch (e) {
                    console.log('Error calculating bounds', e);
                }
            }

            customLabels.forEach((labelData) => {
                const { circle, text, line, fullText } = labelData;

                if (hoveringElements.has(text)) {
                    return;
                }

                if (circle && text) {
                    const circleData = circlePositions.find(cp => cp.circle === circle);
                    if (circleData) {
                        const r = parseFloat(circle.getAttribute('r')) || 7.5;
                        const bestPosition = findBestPosition(
                            text,
                            circleData.coords.x,
                            circleData.coords.y,
                            r,
                            obstacles,
                            fullText,
                            bounds,
                            circle,
                            labelData.data ? labelData.data.labelDirection : null
                        );

                        text.setAttribute('x', bestPosition.x);
                        text.setAttribute('y', bestPosition.y);
                        text.setAttribute('text-anchor', bestPosition.anchor);
                        text.textContent = bestPosition.text;
                        labelData.defaultText = bestPosition.text;

                        if (bestPosition.hasCollision && !bestPosition.isManual) {
                            text.classList.add('collision');
                            text.setAttribute('opacity', '0.3');
                        } else {
                            text.classList.remove('collision');
                            text.setAttribute('opacity', '1');
                        }

                        if (line) {
                            line.setAttribute('opacity', (bestPosition.hasCollision && !bestPosition.isManual) ? '0.2' : '0.5');

                            const cx = circleData.coords.x;
                            const cy = circleData.coords.y;
                            let lx1, ly1, lx2, ly2;

                            const name = bestPosition.name;

                            lx1 = cx; ly1 = cy;
                            lx2 = bestPosition.x; ly2 = bestPosition.y;

                            if (name === 'right') {
                                lx1 = cx + r; ly1 = cy;
                                lx2 = bestPosition.x - 2; ly2 = cy;
                            } else if (name === 'left') {
                                lx1 = cx - r; ly1 = cy;
                                lx2 = bestPosition.x + 2; ly2 = cy;
                            } else if (name === 'above') {
                                lx1 = cx; ly1 = cy - r;
                                lx2 = cx; ly2 = bestPosition.y + 2;
                            } else if (name === 'below') {
                                lx1 = cx; ly1 = cy + r;
                                lx2 = cx; ly2 = bestPosition.y - 12;
                            } else if (name === 'top-right') {
                                lx1 = cx + r * 0.7; ly1 = cy - r * 0.7;
                                lx2 = bestPosition.x - 2; ly2 = bestPosition.y - 4;
                            } else if (name === 'bottom-right') {
                                lx1 = cx + r * 0.7; ly1 = cy + r * 0.7;
                                lx2 = bestPosition.x - 2; ly2 = bestPosition.y - 5;
                            } else if (name === 'bottom-left') {
                                lx1 = cx - r * 0.7; ly1 = cy + r * 0.7;
                                lx2 = bestPosition.x + 2; ly2 = bestPosition.y - 5;
                            } else if (name === 'top-left') {
                                lx1 = cx - r * 0.7; ly1 = cy - r * 0.7;
                                lx2 = bestPosition.x + 2; ly2 = bestPosition.y - 4;
                            }

                            line.setAttribute('x1', lx1);
                            line.setAttribute('y1', ly1);
                            line.setAttribute('x2', lx2);
                            line.setAttribute('y2', ly2);
                        }

                        const bbox = text.getBBox();
                        obstacles.push({
                            x: bbox.x,
                            y: bbox.y,
                            width: bbox.width,
                            height: bbox.height,
                            isCircle: false
                        });
                    }
                }
            });

            isUpdating = false;
        }

        function startPositionUpdater() {
            function updateLoop() {
                updateLabelPositions();
                requestAnimationFrame(updateLoop);
            }

            updateLoop();

            const chartElement = document.getElementById('chart');
            if (chartElement) {
                chartElement.addEventListener('wheel', updateLabelPositions, { passive: true });
                chartElement.addEventListener('mousedown', updateLabelPositions);
                chartElement.addEventListener('mousemove', updateLabelPositions);
                chartElement.addEventListener('mouseup', updateLabelPositions);
            }
        }
    </script>
    <div style="position:fixed;right:10px;bottom:10px;font-size:11px;color:#888;z-index:9999;">
    </div>
</body>

</html>