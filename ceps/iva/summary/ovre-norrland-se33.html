<!doctype html>
<html>
<head>
<meta charset="utf-8">
<script src="https://www.paballand.com/js/d3plus-plot.v0.9.full.min.js"></script>
<style>
body{margin:0;overflow:hidden;font-family:Arial,Helvetica,sans-serif;}
.container{display:flex;flex-direction:column;height:100vh;position:relative;}
#chart{position:absolute;top:0;left:0;right:0;bottom:clamp(110px,14vh,160px);} 
.custom-legend{position:fixed;bottom:5px;left:50%;transform:translateX(-50%);display:flex;justify-content:space-between;align-items:center;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;column-gap:clamp(8px, 2vw, 16px);row-gap:clamp(6px, 1.2vh, 10px);background:rgba(255,255,255,0.88);padding:clamp(6px, 1.4vh, 10px) clamp(10px, 1.6vw, 16px);border-radius:clamp(4px, 1vw, 8px);box-shadow:0 6px 24px rgba(0,0,0,0.12), 0 1px 0 rgba(255,255,255,0.5) inset;border:1px solid rgba(0,0,0,0.06);font-family:Arial, sans-serif;font-size:clamp(9px, 1vw, 13px);z-index:1000;max-width:96vw;white-space:nowrap;}
.legend-square{width:18px;height:18px;min-width:18px;min-height:18px;max-width:18px;max-height:18px;flex:0 0 18px;border-radius:0;display:inline-block;line-height:0;box-sizing:border-box;position:relative;box-shadow:0 0 0 1px rgba(0,0,0,0.15) inset;}
.custom-legend.overlapped{opacity:0.15;}
.custom-legend.overlapped:hover{opacity:1;}
.legend-item{display:flex;align-items:center;gap:8px;cursor:pointer;transition:opacity 0.3s ease;position:relative;line-height:1;}
.legend-item.inactive{opacity:0.3;}
.legend-item:hover{opacity:1;}
.legend-item.active .legend-square::after{content:"✓";position:absolute;top:50%;left:50%;transform:translate(-50%,-55%);font-size:clamp(10px,1.6vw,14px);color:#ffffff;text-shadow:0 0 2px rgba(0,0,0,0.35);}
.legend-item.inactive .legend-square::before{content:"";position:absolute;left:2px;right:2px;top:50%;height:2px;background:rgba(255,255,255,0.9);transform:rotate(-45deg);}
.legend-item{flex:0 0 auto;}
.legend-item span{white-space:nowrap;}
.tooltip-table{width:100%;}
.tooltip-table .data{text-align:right;}
.tooltip-footer{opacity:.5;}
tspan{font-family:"Helvetica","Arial",sans-serif;font-size:100px;font-style:oblique;}

.custom-label {
  font-family: Arial, Helvetica, sans-serif;
  font-size: 10px;
  fill: #000;
  opacity: 1;
  font-weight: normal;
  transition: opacity 0.4s ease, font-size 0.4s ease, font-weight 0.4s ease;
  pointer-events: none;
  transform-origin: center;
}

.custom-label.collision {
  opacity: 0.3;
}

.custom-label.hover {
  opacity: 1 !important;
  font-size: 16px !important;
  font-weight: bold !important;
}

.custom-label.dimmed {
  opacity: 0.35 !important;
}

.custom-label, text.custom-label {
  font-family: Arial, Helvetica, sans-serif !important;
  font-size: 10px !important;
  fill: #000 !important;
  stroke: none !important;
  font-weight: normal !important;
}
</style>
</head>
<body>
<div class="container">
  <div id="chart"></div>
  <div class="controls-section">
    <div class="custom-legend" id="legend"></div>
  </div>
</div>
<script>
function median(v){
  if(!v.length)throw new Error("empty");
  v=[...v].sort((a,b)=>a-b);
  const h=Math.floor(v.length/2);
  return v.length%2?v[h]:(v[h-1]+v[h])/2;
}

function truncateText(text, maxLength = 20) {
  if (text.length <= maxLength) {
    return text;
  }
  return text.substring(0, maxLength) + "...";
}

function rectanglesOverlap(a,b,pad=0){
  return !((a.x + a.width + pad) < (b.x - pad) || (b.x + b.width + pad) < (a.x - pad) || (a.y + a.height + pad) < (b.y - pad) || (b.y + b.height + pad) < (a.y - pad));
}
function bboxOfCircle(cx,cy,r){ return {x:cx - r, y:cy - r, width:r*2, height:r*2}; }

function getPositionOptions(cx,cy,r,p=6){
  const dy=10;
  const dx=6;
  return [
    {name:'right',x:cx+r+p,y:cy+3,anchor:'start'},
    {name:'right-up',x:cx+r+p+dx,y:cy-dy,anchor:'start'},
    {name:'right-down',x:cx+r+p+dx,y:cy+dy,anchor:'start'},
    {name:'left',x:cx-r-p,y:cy+3,anchor:'end'},
    {name:'left-up',x:cx-r-p-dx,y:cy-dy,anchor:'end'},
    {name:'left-down',x:cx-r-p-dx,y:cy+dy,anchor:'end'},
    {name:'above',x:cx,y:cy-r-p,anchor:'middle'},
    {name:'below',x:cx,y:cy+r+p+10,anchor:'middle'}
  ];
}


function getSVGBounds(svg){
  const vb = svg.viewBox && svg.viewBox.baseVal;
  if(vb && vb.width && vb.height){ return {x:vb.x, y:vb.y, width:vb.width, height:vb.height}; }
  const w = parseFloat(svg.getAttribute('width')) || svg.clientWidth || 0;
  const h = parseFloat(svg.getAttribute('height')) || svg.clientHeight || 0;
  return {x:0, y:0, width:w, height:h};
}


function outsideBounds(tb, bounds, pad=2){
  return tb.x < bounds.x + pad || tb.y < bounds.y + pad || (tb.x + tb.width) > (bounds.x + bounds.width - pad) || (tb.y + tb.height) > (bounds.y + bounds.height - pad);
}


function detectAxesBounds(svg, base){
  const lines = svg.querySelectorAll('line');
  let leftX = null;
  let bottomY = null;
  const minTall = Math.max(40, base.height * 0.3);
  const minWide = Math.max(40, base.width * 0.3);
  lines.forEach(l=>{
    const x1 = parseFloat(l.getAttribute('x1'));
    const x2 = parseFloat(l.getAttribute('x2'));
    const y1 = parseFloat(l.getAttribute('y1'));
    const y2 = parseFloat(l.getAttribute('y2'));
    if([x1,x2,y1,y2].some(v=>isNaN(v))) return;
    if(Math.abs(x1 - x2) < 0.5 && Math.abs(y2 - y1) >= minTall){
      leftX = leftX === null ? x1 : Math.min(leftX, x1);
    }
    if(Math.abs(y1 - y2) < 0.5 && Math.abs(x2 - x1) >= minWide){
      bottomY = bottomY === null ? Math.max(y1, y2) : Math.max(bottomY, y1, y2);
    }
  });
  const pad = 6;
  const bounds = {x:base.x, y:base.y, width:base.width, height:base.height};
  if(leftX !== null){
    bounds.x = Math.max(bounds.x, leftX + pad);
    bounds.width = base.width - (bounds.x - base.x);
  }
  if(bottomY !== null){
    const newH = Math.max(0, (bottomY - base.y) - pad);
    bounds.height = Math.min(bounds.height, newH);
  }
  return bounds;
}

function getPlotBounds(svg){
  const base = getSVGBounds(svg);
  return detectAxesBounds(svg, base);
}

function hasCollision(textElement, allCircles, placedBoxes, bounds){
  try{
    const tb=textElement.getBBox();
    if(bounds && outsideBounds(tb,bounds,2)) return true;
    for(const c of allCircles){
      const r=parseFloat(c.circle.getAttribute('r'))||7.5;
      const cb=bboxOfCircle(c.coords.x,c.coords.y,r);
      if(rectanglesOverlap(tb,cb,2)) return true;
    }
    if(placedBoxes && placedBoxes.length){
      for(const b of placedBoxes){ if(rectanglesOverlap(tb,b,2)) return true; }
    }
    return false;
  }catch(e){ return false; }
}

function findBestPosition(textElement,cx,cy,r,allCircles,fullText,placedBoxes,bounds){
  const positions=getPositionOptions(cx,cy,r);
  textElement.textContent=fullText;
  for(const pos of positions){
    textElement.setAttribute('x',pos.x);
    textElement.setAttribute('y',pos.y);
    textElement.setAttribute('text-anchor',pos.anchor);
    if(!hasCollision(textElement,allCircles,placedBoxes,bounds)){
      return {...pos,text:fullText,hasCollision:false};
    }
  }
  const truncated=truncateText(fullText,20);
  textElement.textContent=truncated;
  for(const pos of positions){
    textElement.setAttribute('x',pos.x);
    textElement.setAttribute('y',pos.y);
    textElement.setAttribute('text-anchor',pos.anchor);
    if(!hasCollision(textElement,allCircles,placedBoxes,bounds)){
      return {...pos,text:truncated,hasCollision:true};
    }
  }
  const fallback=positions[0];
  return {...fallback,text:truncated,hasCollision:true};
}

function getBoundData(element) {
  if (element.__data__) {
    return element.__data__;
  }
  let parent = element.parentElement;
  while (parent) {
    if (parent.__data__) {
      return parent.__data__;
    }
    parent = parent.parentElement;
  }
  return null;
}

function findMatchingDataPoint(circle) {
  const bound = circle.__data__ || d3.select(circle).datum();
  if (bound) return bound;
  console.warn('No data bound to circle:', circle);
  return null;
}

var data= 

 [
  {
    "domain": "Additive Manufacturing (3D Printing)",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 10.86,
    "reldens.op": 58.75,
    "y": 57.33,
    "reldens.reg": 12.62,
    "parent": "Materials and Production Technologies",
    "color": "#C8B797",
    "rank.reg": 10,
    "rank.op": 23,
    "rank.cb": 29,
    "rank": 62,
    "rank.rs": 36.51,
    "id": "Additive Manufacturing (3D Printing)",
    "x": 36.51,
    "value": 1
  },
  {
    "domain": "Advanced Materials",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 12.82,
    "reldens.op": 53.8,
    "y": 64.07,
    "reldens.reg": 9.23,
    "parent": "Materials and Production Technologies",
    "color": "#C8B797",
    "rank.reg": 5,
    "rank.op": 17,
    "rank.cb": 36,
    "rank": 58,
    "rank.rs": 32.28,
    "id": "Advanced Materials",
    "x": 32.28,
    "value": 1
  },
  {
    "domain": "Advanced Therapy Medicinal Products (ATMP)",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 24.22,
    "reldens.op": 36.66,
    "y": 71.8,
    "reldens.reg": 3.07,
    "parent": "Biotechnologies and Life Sciences",
    "color": "#800020",
    "rank.reg": 1,
    "rank.op": 4,
    "rank.cb": 44,
    "rank": 49,
    "rank.rs": 22.75,
    "id": "Advanced Therapy Medicinal Products (ATMP)",
    "x": 22.75,
    "value": 1
  },
  {
    "domain": "Aeronautics Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 5.87,
    "reldens.op": 60.52,
    "y": 63.58,
    "reldens.reg": 24.22,
    "parent": "Transportation, Aerospace, and Security Technologies",
    "color": "#E1A100",
    "rank.reg": 23,
    "rank.op": 29,
    "rank.cb": 13,
    "rank": 65,
    "rank.rs": 39.68,
    "id": "Aeronautics Technologies",
    "x": 39.68,
    "value": 1
  },
  {
    "domain": "Artificial Intelligence",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 15.9,
    "reldens.op": 49.75,
    "y": 72.96,
    "reldens.reg": 58.85,
    "parent": "Artificial Intelligence and Autonomous Systems Technologies",
    "color": "#232F4B",
    "rank.reg": 40,
    "rank.op": 15,
    "rank.cb": 38,
    "rank": 93,
    "rank.rs": 69.31,
    "id": "Artificial Intelligence",
    "x": 69.31,
    "value": 1
  },
  {
    "domain": "Augmented Reality (AR) and Virtual Reality (VR)",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 12.74,
    "reldens.op": 74.92,
    "y": 72.71,
    "reldens.reg": 57.82,
    "parent": "Digital Technologies",
    "color": "#B0E3DD",
    "rank.reg": 39,
    "rank.op": 44,
    "rank.cb": 35,
    "rank": 118,
    "rank.rs": 95.77,
    "id": "Augmented Reality (AR) and Virtual Reality (VR)",
    "x": 95.77,
    "value": 1
  },
  {
    "domain": "Autonomous Vehicles",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 8.46,
    "reldens.op": 53.83,
    "y": 75.82,
    "reldens.reg": 42.48,
    "parent": "Artificial Intelligence and Autonomous Systems Technologies",
    "color": "#232F4B",
    "rank.reg": 34,
    "rank.op": 18,
    "rank.cb": 21,
    "rank": 73,
    "rank.rs": 48.15,
    "id": "Autonomous Vehicles",
    "x": 48.15,
    "value": 1
  },
  {
    "domain": "Batteries",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 5.49,
    "reldens.op": 37.8,
    "y": 69.04,
    "reldens.reg": 12.38,
    "parent": "Energy and Electrification Technologies",
    "color": "#8cab79",
    "rank.reg": 7.5,
    "rank.op": 8,
    "rank.cb": 12,
    "rank": 27.5,
    "rank.rs": 0,
    "id": "Batteries",
    "x": 0,
    "value": 1
  },
  {
    "domain": "Biobased Materials & Biomanufacturing",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 2.85,
    "reldens.op": 70.32,
    "y": 56.26,
    "reldens.reg": 17.86,
    "parent": "Biotechnologies and Life Sciences",
    "color": "#800020",
    "rank.reg": 16,
    "rank.op": 42,
    "rank.cb": 6,
    "rank": 64,
    "rank.rs": 38.62,
    "id": "Biobased Materials & Biomanufacturing",
    "x": 38.62,
    "value": 1
  },
  {
    "domain": "Biofuels",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 2.05,
    "reldens.op": 76.45,
    "y": 47.67,
    "reldens.reg": 30.71,
    "parent": "Biotechnologies and Life Sciences",
    "color": "#800020",
    "rank.reg": 26,
    "rank.op": 45,
    "rank.cb": 1,
    "rank": 72,
    "rank.rs": 47.09,
    "id": "Biofuels",
    "x": 47.09,
    "value": 1
  },
  {
    "domain": "Biotechnology",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 17.71,
    "reldens.op": 41.68,
    "y": 64.2,
    "reldens.reg": 12.42,
    "parent": "Biotechnologies and Life Sciences",
    "color": "#800020",
    "rank.reg": 9,
    "rank.op": 12,
    "rank.cb": 40,
    "rank": 61,
    "rank.rs": 35.45,
    "id": "Biotechnology",
    "x": 35.45,
    "value": 1
  },
  {
    "domain": "Blockchain Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 24.59,
    "reldens.op": 65.24,
    "y": 67.05,
    "reldens.reg": 67.61,
    "parent": "Digital Technologies",
    "color": "#B0E3DD",
    "rank.reg": 44,
    "rank.op": 32,
    "rank.cb": 45,
    "rank": 121,
    "rank.rs": 98.94,
    "id": "Blockchain Technologies",
    "x": 98.94,
    "value": 1
  },
  {
    "domain": "Cloud Computing and Edge Computing",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 24,
    "reldens.op": 59.3,
    "y": 76.87,
    "reldens.reg": 54.75,
    "parent": "Digital Technologies",
    "color": "#B0E3DD",
    "rank.reg": 37,
    "rank.op": 26,
    "rank.cb": 43,
    "rank": 106,
    "rank.rs": 83.07,
    "id": "Cloud Computing and Edge Computing",
    "x": 83.07,
    "value": 1
  },
  {
    "domain": "Computer Vision, Language Processing, Object Recognition",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 10.55,
    "reldens.op": 61.49,
    "y": 76.6,
    "reldens.reg": 65.8,
    "parent": "Artificial Intelligence and Autonomous Systems Technologies",
    "color": "#232F4B",
    "rank.reg": 43,
    "rank.op": 30,
    "rank.cb": 27,
    "rank": 100,
    "rank.rs": 76.72,
    "id": "Computer Vision, Language Processing, Object Recognition",
    "x": 76.72,
    "value": 1
  },
  {
    "domain": "Cybersecurity Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 10.28,
    "reldens.op": 37.43,
    "y": 70.95,
    "reldens.reg": 59.8,
    "parent": "Digital Technologies",
    "color": "#B0E3DD",
    "rank.reg": 41,
    "rank.op": 6,
    "rank.cb": 25,
    "rank": 72,
    "rank.rs": 47.09,
    "id": "Cybersecurity Technologies",
    "x": 47.09,
    "value": 1
  },
  {
    "domain": "Data Analytics Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 12.57,
    "reldens.op": 60.3,
    "y": 77.33,
    "reldens.reg": 71.93,
    "parent": "Artificial Intelligence and Autonomous Systems Technologies",
    "color": "#232F4B",
    "rank.reg": 47,
    "rank.op": 28,
    "rank.cb": 34,
    "rank": 109,
    "rank.rs": 86.24,
    "id": "Data Analytics Technologies",
    "x": 86.24,
    "value": 1
  },
  {
    "domain": "Defence Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 5.93,
    "reldens.op": 62.51,
    "y": 47.49,
    "reldens.reg": 17.82,
    "parent": "Transportation, Aerospace, and Security Technologies",
    "color": "#E1A100",
    "rank.reg": 15,
    "rank.op": 31,
    "rank.cb": 14,
    "rank": 60,
    "rank.rs": 34.39,
    "id": "Defence Technologies",
    "x": 34.39,
    "value": 1
  },
  {
    "domain": "Drones",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 8.22,
    "reldens.op": 67.08,
    "y": 68.96,
    "reldens.reg": 37.33,
    "parent": "Artificial Intelligence and Autonomous Systems Technologies",
    "color": "#232F4B",
    "rank.reg": 32,
    "rank.op": 36,
    "rank.cb": 20,
    "rank": 88,
    "rank.rs": 64.02,
    "id": "Drones",
    "x": 64.02,
    "value": 1
  },
  {
    "domain": "Financial Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 16.45,
    "reldens.op": 67.45,
    "y": 69.92,
    "reldens.reg": 68.74,
    "parent": "Digital Technologies",
    "color": "#B0E3DD",
    "rank.reg": 45,
    "rank.op": 38,
    "rank.cb": 39,
    "rank": 122,
    "rank.rs": 100,
    "id": "Financial Technologies",
    "x": 100,
    "value": 1
  },
  {
    "domain": "Heat Pumps",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 2.07,
    "reldens.op": 80.11,
    "y": 59.18,
    "reldens.reg": 18.68,
    "parent": "Energy and Electrification Technologies",
    "color": "#8cab79",
    "rank.reg": 17,
    "rank.op": 46,
    "rank.cb": 2,
    "rank": 65,
    "rank.rs": 39.68,
    "id": "Heat Pumps",
    "x": 39.68,
    "value": 1
  },
  {
    "domain": "High Performance Computing",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 12.11,
    "reldens.op": 35.55,
    "y": 76.49,
    "reldens.reg": 60.6,
    "parent": "Digital Technologies",
    "color": "#B0E3DD",
    "rank.reg": 42,
    "rank.op": 3,
    "rank.cb": 31,
    "rank": 76,
    "rank.rs": 51.32,
    "id": "High Performance Computing",
    "x": 51.32,
    "value": 1
  },
  {
    "domain": "Hydrogen Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 3.86,
    "reldens.op": 69.68,
    "y": 68.21,
    "reldens.reg": 12.38,
    "parent": "Energy and Electrification Technologies",
    "color": "#8cab79",
    "rank.reg": 7.5,
    "rank.op": 41,
    "rank.cb": 9,
    "rank": 57.5,
    "rank.rs": 31.75,
    "id": "Hydrogen Technologies",
    "x": 31.75,
    "value": 1
  },
  {
    "domain": "Hydropower Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 2.51,
    "reldens.op": 88.79,
    "y": 53.86,
    "reldens.reg": 38.64,
    "parent": "Energy and Electrification Technologies",
    "color": "#8cab79",
    "rank.reg": 33,
    "rank.op": 48,
    "rank.cb": 5,
    "rank": 86,
    "rank.rs": 61.9,
    "id": "Hydropower Technologies",
    "x": 61.9,
    "value": 1
  },
  {
    "domain": "Industrial Automation and Process Control",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 10.14,
    "reldens.op": 56.36,
    "y": 72.65,
    "reldens.reg": 37.27,
    "parent": "Materials and Production Technologies",
    "color": "#C8B797",
    "rank.reg": 31,
    "rank.op": 20,
    "rank.cb": 24,
    "rank": 75,
    "rank.rs": 50.26,
    "id": "Industrial Automation and Process Control",
    "x": 50.26,
    "value": 1
  },
  {
    "domain": "Internet of Things (IoT)",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 12.08,
    "reldens.op": 59.27,
    "y": 75.73,
    "reldens.reg": 70.21,
    "parent": "Digital Technologies",
    "color": "#B0E3DD",
    "rank.reg": 46,
    "rank.op": 25,
    "rank.cb": 30,
    "rank": 101,
    "rank.rs": 77.78,
    "id": "Internet of Things (IoT)",
    "x": 77.78,
    "value": 1
  },
  {
    "domain": "Life Sciences & Pharmaceuticals",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 25.15,
    "reldens.op": 38.37,
    "y": 60.42,
    "reldens.reg": 6.15,
    "parent": "Biotechnologies and Life Sciences",
    "color": "#800020",
    "rank.reg": 2,
    "rank.op": 9,
    "rank.cb": 46,
    "rank": 57,
    "rank.rs": 31.22,
    "id": "Life Sciences & Pharmaceuticals",
    "x": 31.22,
    "value": 1
  },
  {
    "domain": "Maritime Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 6.42,
    "reldens.op": 66.42,
    "y": 50.04,
    "reldens.reg": 31.11,
    "parent": "Transportation, Aerospace, and Security Technologies",
    "color": "#E1A100",
    "rank.reg": 27,
    "rank.op": 34,
    "rank.cb": 17,
    "rank": 78,
    "rank.rs": 53.44,
    "id": "Maritime Technologies",
    "x": 53.44,
    "value": 1
  },
  {
    "domain": "Medtech",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 47,
    "reldens.op": 58.42,
    "y": 58.67,
    "reldens.reg": 21.51,
    "parent": "Biotechnologies and Life Sciences",
    "color": "#800020",
    "rank.reg": 19,
    "rank.op": 22,
    "rank.cb": 48,
    "rank": 89,
    "rank.rs": 65.08,
    "id": "Medtech",
    "x": 65.08,
    "value": 1
  },
  {
    "domain": "Metals and Minerals Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 5.1,
    "reldens.op": 59.49,
    "y": 58.29,
    "reldens.reg": 14.84,
    "parent": "Materials and Production Technologies",
    "color": "#C8B797",
    "rank.reg": 12,
    "rank.op": 27,
    "rank.cb": 11,
    "rank": 50,
    "rank.rs": 23.81,
    "id": "Metals and Minerals Technologies",
    "x": 23.81,
    "value": 1
  },
  {
    "domain": "Mobile networks (e.g. 5G and 6G)",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 6.76,
    "reldens.op": 37.6,
    "y": 75.1,
    "reldens.reg": 47.93,
    "parent": "Digital Technologies",
    "color": "#B0E3DD",
    "rank.reg": 35,
    "rank.op": 7,
    "rank.cb": 18,
    "rank": 60,
    "rank.rs": 34.39,
    "id": "Mobile networks (e.g. 5G and 6G)",
    "x": 34.39,
    "value": 1
  },
  {
    "domain": "Nuclear Energy Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 2.44,
    "reldens.op": 51.72,
    "y": 55.19,
    "reldens.reg": 20.93,
    "parent": "Energy and Electrification Technologies",
    "color": "#8cab79",
    "rank.reg": 18,
    "rank.op": 16,
    "rank.cb": 4,
    "rank": 38,
    "rank.rs": 11.11,
    "id": "Nuclear Energy Technologies",
    "x": 11.11,
    "value": 1
  },
  {
    "domain": "Personalised Medicine",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 19.49,
    "reldens.op": 41.13,
    "y": 64.87,
    "reldens.reg": 31.31,
    "parent": "Biotechnologies and Life Sciences",
    "color": "#800020",
    "rank.reg": 28,
    "rank.op": 11,
    "rank.cb": 42,
    "rank": 81,
    "rank.rs": 56.61,
    "id": "Personalised Medicine",
    "x": 56.61,
    "value": 1
  },
  {
    "domain": "Photonics and Spintronics",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 8.61,
    "reldens.op": 18.58,
    "y": 65.17,
    "reldens.reg": 10.57,
    "parent": "Digital Technologies",
    "color": "#B0E3DD",
    "rank.reg": 6,
    "rank.op": 1,
    "rank.cb": 22,
    "rank": 29,
    "rank.rs": 1.59,
    "id": "Photonics and Spintronics",
    "x": 1.59,
    "value": 1
  },
  {
    "domain": "Production Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 10.74,
    "reldens.op": 67.35,
    "y": 64.66,
    "reldens.reg": 21.52,
    "parent": "Materials and Production Technologies",
    "color": "#C8B797",
    "rank.reg": 20,
    "rank.op": 37,
    "rank.cb": 28,
    "rank": 85,
    "rank.rs": 60.85,
    "id": "Production Technologies",
    "x": 60.85,
    "value": 1
  },
  {
    "domain": "Propulsion Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 6.07,
    "reldens.op": 72.56,
    "y": 62.22,
    "reldens.reg": 16.67,
    "parent": "Transportation, Aerospace, and Security Technologies",
    "color": "#E1A100",
    "rank.reg": 14,
    "rank.op": 43,
    "rank.cb": 16,
    "rank": 73,
    "rank.rs": 48.15,
    "id": "Propulsion Technologies",
    "x": 48.15,
    "value": 1
  },
  {
    "domain": "Quantum Technologies and Computing",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 10.39,
    "reldens.op": 41.73,
    "y": 73.11,
    "reldens.reg": 32.88,
    "parent": "Digital Technologies",
    "color": "#B0E3DD",
    "rank.reg": 29,
    "rank.op": 13,
    "rank.cb": 26,
    "rank": 68,
    "rank.rs": 42.86,
    "id": "Quantum Technologies and Computing",
    "x": 42.86,
    "value": 1
  },
  {
    "domain": "Recycling Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 4.37,
    "reldens.op": 85.18,
    "y": 53.26,
    "reldens.reg": 22.33,
    "parent": "Materials and Production Technologies",
    "color": "#C8B797",
    "rank.reg": 21,
    "rank.op": 47,
    "rank.cb": 10,
    "rank": 78,
    "rank.rs": 53.44,
    "id": "Recycling Technologies",
    "x": 53.44,
    "value": 1
  },
  {
    "domain": "Robotics",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 13.95,
    "reldens.op": 68.02,
    "y": 68.92,
    "reldens.reg": 25.24,
    "parent": "Artificial Intelligence and Autonomous Systems Technologies",
    "color": "#232F4B",
    "rank.reg": 24,
    "rank.op": 40,
    "rank.cb": 37,
    "rank": 101,
    "rank.rs": 77.78,
    "id": "Robotics",
    "x": 77.78,
    "value": 1
  },
  {
    "domain": "Safety and Security Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 9.07,
    "reldens.op": 68,
    "y": 63.11,
    "reldens.reg": 26.49,
    "parent": "Transportation, Aerospace, and Security Technologies",
    "color": "#E1A100",
    "rank.reg": 25,
    "rank.op": 39,
    "rank.cb": 23,
    "rank": 87,
    "rank.rs": 62.96,
    "id": "Safety and Security Technologies",
    "x": 62.96,
    "value": 1
  },
  {
    "domain": "Semiconductors and Chips",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 12.22,
    "reldens.op": 27.95,
    "y": 75.06,
    "reldens.reg": 8.07,
    "parent": "Digital Technologies",
    "color": "#B0E3DD",
    "rank.reg": 4,
    "rank.op": 2,
    "rank.cb": 32,
    "rank": 38,
    "rank.rs": 11.11,
    "id": "Semiconductors and Chips",
    "x": 11.11,
    "value": 1
  },
  {
    "domain": "Sensor Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 28.99,
    "reldens.op": 57,
    "y": 69.08,
    "reldens.reg": 33.96,
    "parent": "Artificial Intelligence and Autonomous Systems Technologies",
    "color": "#232F4B",
    "rank.reg": 30,
    "rank.op": 21,
    "rank.cb": 47,
    "rank": 98,
    "rank.rs": 74.6,
    "id": "Sensor Technologies",
    "x": 74.6,
    "value": 1
  },
  {
    "domain": "Smart Grids",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 3.72,
    "reldens.op": 54.14,
    "y": 61.97,
    "reldens.reg": 48.1,
    "parent": "Energy and Electrification Technologies",
    "color": "#8cab79",
    "rank.reg": 36,
    "rank.op": 19,
    "rank.cb": 8,
    "rank": 63,
    "rank.rs": 37.57,
    "id": "Smart Grids",
    "x": 37.57,
    "value": 1
  },
  {
    "domain": "Software Engineering and Systems Development",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 12.43,
    "reldens.op": 37.27,
    "y": 76.2,
    "reldens.reg": 77.98,
    "parent": "Digital Technologies",
    "color": "#B0E3DD",
    "rank.reg": 48,
    "rank.op": 5,
    "rank.cb": 33,
    "rank": 86,
    "rank.rs": 61.9,
    "id": "Software Engineering and Systems Development",
    "x": 61.9,
    "value": 1
  },
  {
    "domain": "Solar Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 3.12,
    "reldens.op": 65.36,
    "y": 55.12,
    "reldens.reg": 14.97,
    "parent": "Energy and Electrification Technologies",
    "color": "#8cab79",
    "rank.reg": 13,
    "rank.op": 33,
    "rank.cb": 7,
    "rank": 53,
    "rank.rs": 26.98,
    "id": "Solar Technologies",
    "x": 26.98,
    "value": 1
  },
  {
    "domain": "Space Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 5.97,
    "reldens.op": 49.67,
    "y": 72.75,
    "reldens.reg": 57.23,
    "parent": "Transportation, Aerospace, and Security Technologies",
    "color": "#E1A100",
    "rank.reg": 38,
    "rank.op": 14,
    "rank.cb": 15,
    "rank": 67,
    "rank.rs": 41.8,
    "id": "Space Technologies",
    "x": 41.8,
    "value": 1
  },
  {
    "domain": "Synthetic Biology",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 19.2,
    "reldens.op": 38.7,
    "y": 65.95,
    "reldens.reg": 6.81,
    "parent": "Biotechnologies and Life Sciences",
    "color": "#800020",
    "rank.reg": 3,
    "rank.op": 10,
    "rank.cb": 41,
    "rank": 54,
    "rank.rs": 28.04,
    "id": "Synthetic Biology",
    "x": 28.04,
    "value": 1
  },
  {
    "domain": "Transport Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 7.13,
    "reldens.op": 59.07,
    "y": 62.04,
    "reldens.reg": 23.15,
    "parent": "Transportation, Aerospace, and Security Technologies",
    "color": "#E1A100",
    "rank.reg": 22,
    "rank.op": 24,
    "rank.cb": 19,
    "rank": 65,
    "rank.rs": 39.68,
    "id": "Transport Technologies",
    "x": 39.68,
    "value": 1
  },
  {
    "domain": "Wind Technologies",
    "geo": "Övre Norrland (SE33)",
    "reldens.cb": 2.35,
    "reldens.op": 66.98,
    "y": 39.65,
    "reldens.reg": 12.64,
    "parent": "Energy and Electrification Technologies",
    "color": "#8cab79",
    "rank.reg": 11,
    "rank.op": 35,
    "rank.cb": 3,
    "rank": 49,
    "rank.rs": 22.75,
    "id": "Wind Technologies",
    "x": 22.75,
    "value": 1
  }
]  ;

const xVals=data.map(d=>d.x);
const yVals=data.map(d=>d.y);
const medianX=median(xVals);
const medianY=median(yVals);
const xDomain=[0,110];
const minY=Math.min(...yVals)-1;
const maxY=Math.max(...yVals)+2;

const parents = Array.from(new Set(data.map(d=>d.parent)));
const parentColors = {};
parents.forEach(p=>{ const c = (data.find(d=>d.parent===p)||{}).color || "#666666"; parentColors[p]=c; });
let activeParents = new Set(parents);
function renderLegend(){
  const legend = document.getElementById('legend');
  if(!legend) return;
  legend.innerHTML = '';
  parents.forEach(p=>{
    const item = document.createElement('div');
    item.className = 'legend-item active';
    item.setAttribute('data-group', p);
    item.setAttribute('role','button');
    item.setAttribute('tabindex','0');
    item.setAttribute('aria-pressed','true');
    const square = document.createElement('div');
    square.className = 'legend-square';
    square.style.backgroundColor = parentColors[p];
    const label = document.createElement('span');
    label.textContent = p;
    item.appendChild(square);
    item.appendChild(label);
    item.addEventListener('click', ()=>toggleGroup(p,item));
    item.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggleGroup(p,item); } });
    legend.appendChild(item);
  });
}
function adjustLayoutForLegend(){
  const chart=document.getElementById('chart');
  const legend=document.getElementById('legend');
  if(!chart||!legend)return;
  const h=Math.ceil(legend.getBoundingClientRect().height);
  chart.style.bottom=(h+5)+'px';
}
function toggleGroup(group,item){
  if(activeParents.has(group)){
    activeParents.delete(group);
    item.classList.remove('active');
    item.classList.add('inactive');
    item.setAttribute('aria-pressed','false');
  } else {
    activeParents.add(group);
    item.classList.add('active');
    item.classList.remove('inactive');
    item.setAttribute('aria-pressed','true');
  }
  updateVisualization();
}
function updateVisualization(){
  const filtered = data.filter(d=>activeParents.has(d.parent));
  plot.data(filtered).render();
  setTimeout(adjustLayoutForLegend,0);
  setTimeout(()=>{
    document.querySelectorAll('text.custom-label').forEach(el=>el.remove());
    customLabels = [];
    hoveringElements = new Set();
    initializeCustomLabels();
    adjustLayoutForLegend();
  },400);
}
renderLegend();
adjustLayoutForLegend();
window.addEventListener('resize',adjustLayoutForLegend);

let customLabels = [];
let isUpdating = false;
let hoveringElements = new Set();

var plot = new d3plus.Plot()
  .select("#chart")
  .data(data)
  .annotations([{data:[{id:"Trend",x:medianX,y:minY},
  {id:"Trend",x:medianX,y:maxY},
  {id:"Baseline",x:xDomain[0],y:medianY},
  {id:"Baseline",x:xDomain[1],y:medianY}],shape:"Line",stroke:"#c3c3c3",strokeDasharray:"10",strokeWidth:2}])
  .groupBy("id")
  .tooltip(false)
  .size("value")
  .sizeMin(15)
  .sizeMax(15)
  .color("color")
  .label("")
  .shapeConfig({
    Circle:{
      labelConfig:{fontSize:0}
    }
  })
  .yConfig({
    title:"Technological Complexity",
    titleConfig:{fontSize:()=>16},
    gridConfig:{stroke:"transparent"},
    shapeConfig:{labelConfig:{fontSize:()=>16}}
  })
  .xDomain(xDomain)
  .xConfig({
    title:"Composite Relatedness Density",
    titleConfig:{fontSize:()=>16},
    gridConfig:{stroke:"transparent"},
    shapeConfig:{labelConfig:{fontSize:()=>16}}
  })
  .legend(false)
  .downloadButton(false)
  .render();

setTimeout(() => {
  initializeCustomLabels();
  if(!window.__labelsUpdaterStarted){ startPositionUpdater(); window.__labelsUpdaterStarted = true; }
}, 500);

function initializeCustomLabels() {
  const svg = document.querySelector('#chart svg');
  if (!svg) {
    setTimeout(initializeCustomLabels, 100);
    return;
  }
  
  const circles = svg.querySelectorAll('circle');
  console.log('Found circles:', circles.length);
  
  circles.forEach((circle, index) => {
    const matchingData = findMatchingDataPoint(circle);
    
    if (matchingData) {
      console.log('Circle', index, 'matched to data:', matchingData.id);
      
      const fullText = matchingData.id;
      const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      text.setAttribute('class', 'custom-label');
      text.setAttribute('data-id', matchingData.id);
      text.setAttribute('text-anchor', 'start');
      text.setAttribute('font-family', 'Arial, Helvetica, sans-serif');
      text.setAttribute('font-size', '10');
      text.setAttribute('fill', '#000');
      text.setAttribute('font-weight', 'normal');
      text.textContent = fullText;
      
      const svgEl = document.querySelector('#chart svg');
      svgEl.appendChild(text);
      
      customLabels.push({
        circle: circle,
        text: text,
        data: matchingData,
        fullText: fullText,
        defaultText: fullText,
        savedPosition: null
      });
      
      circle.addEventListener('mouseenter', () => {
        hoveringElements.add(text);
        
        const labelData = customLabels.find(l => l.circle === circle);
        if (labelData) {
          labelData.savedPosition = {
            x: text.getAttribute('x'),
            y: text.getAttribute('y'),
            anchor: text.getAttribute('text-anchor'),
            content: text.textContent
          };
        }

        customLabels.forEach(l=>{
          if(l.circle!==circle){
            l.text.classList.add('dimmed');
            l.circle.style.opacity='0.35';
          } else {
            l.text.classList.remove('dimmed');
            l.circle.style.opacity='1';
          }
        });
        
        text.classList.add('hover');
        text.textContent = fullText;
      });
      
      circle.addEventListener('mouseleave', () => {
        hoveringElements.delete(text);

        customLabels.forEach(l=>{
          l.text.classList.remove('dimmed');
          l.circle.style.opacity='';
        });
        
        text.classList.remove('hover');
        
        const labelData = customLabels.find(l => l.circle === circle);
        if (labelData && labelData.savedPosition) {
          text.setAttribute('x', labelData.savedPosition.x);
          text.setAttribute('y', labelData.savedPosition.y);
          text.setAttribute('text-anchor', labelData.savedPosition.anchor);
          text.textContent = labelData.savedPosition.content;
        }
      });
    } else {
      console.log('Circle', index, 'could not be matched to data');
    }
  });
  
  updateLabelPositions();
}

function updateLabelPositions() {
  if (isUpdating) return;
  isUpdating = true;
  
  const svg = document.querySelector('#chart svg');
  if (!svg) {
    isUpdating = false;
    return;
  }

  const bounds = getPlotBounds(svg);
  
  const circlePositions = [];
  
  customLabels.forEach(({circle, text}) => {
    if (circle && text) {
      const bbox = circle.getBoundingClientRect();
      const svgRect = svg.getBoundingClientRect();
      
      const svgPoint = svg.createSVGPoint();
      svgPoint.x = bbox.left + bbox.width/2 - svgRect.left;
      svgPoint.y = bbox.top + bbox.height/2 - svgRect.top;
      
      const screenCTM = svg.getScreenCTM();
      if (screenCTM) {
        const svgCoords = svgPoint.matrixTransform(screenCTM.inverse());
        circlePositions.push({
          circle: circle,
          coords: svgCoords
        });
      }
    }
  });
  
  const labelsOrdered=[...customLabels].map(ld=>{
    const cp=circlePositions.find(cp=>cp.circle===ld.circle);
    return {ld,cp};
  }).filter(d=>d.cp).sort((a,b)=>a.cp.coords.y-b.cp.coords.y || a.cp.coords.x-b.cp.coords.x);
  const placedBoxes=[];
  labelsOrdered.forEach(({ld,cp})=>{
    const {circle,text,fullText}=ld;
    const r = parseFloat(circle.getAttribute('r')) || 7.5;
    if (hoveringElements.has(text)) {
      return;
    }
    const pos = findBestPosition(text, cp.coords.x, cp.coords.y, r, circlePositions, fullText, placedBoxes, bounds);
    text.setAttribute('x', pos.x);
    text.setAttribute('y', pos.y);
    text.setAttribute('text-anchor', pos.anchor);
    text.textContent = pos.text;
    ld.defaultText = pos.text;
    const bb = text.getBBox();
    if(!pos.hasCollision){
      text.classList.remove('collision');
      text.setAttribute('opacity','1');
      placedBoxes.push({x:bb.x,y:bb.y,width:bb.width,height:bb.height});
    } else {
      text.classList.add('collision');
      text.setAttribute('opacity','0.35');
    }
  });
  isUpdating = false;
}

function startPositionUpdater() {
  function updateLoop() {
    updateLabelPositions();
    requestAnimationFrame(updateLoop);
  }
  
  updateLoop();
  
  const chartElement = document.getElementById('chart');
  if (chartElement) {
    chartElement.addEventListener('wheel', updateLabelPositions, { passive: true });
    chartElement.addEventListener('mousedown', updateLabelPositions);
    chartElement.addEventListener('mousemove', updateLabelPositions);
    chartElement.addEventListener('mouseup', updateLabelPositions);
  }
}
</script>
</body>
</html>
